<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="SHIV.png">
  <title>School Fee Manager</title>
  <style>
    :root{
      --bg:#071022; --card:#0b1624; --muted:#98a8b8; --accent:#1ea7ff; --glass:rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#061226 0%,#03121a 100%);color:#e6eef6}
    .wrap{max-width:1180px;margin:18px auto;padding:16px}
    header.top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:64px;height:64px;border-radius:10px;background:linear-gradient(135deg,#07202a,#0b2440);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    button,input,select{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:8px 10px;border-radius:8px}
    main{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-top:14px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);vertical-align:middle}
    th{font-size:13px;text-align:left;color:var(--muted)}
    .thumb{width:40px;height:40px;border-radius:6px;object-fit:cover;border:1px solid rgba(255,255,255,0.06)}
    .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .small{font-size:13px;padding:6px 8px}
    .dashboard .cards{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
    .badge{padding:8px;border-radius:10px;background:var(--glass);display:inline-block}
    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
    @media(max-width:980px){main{grid-template-columns:1fr} .brand h1{font-size:16px}}

    /* Modal styles (centered) */
    .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .modal{background:#fff;color:#000;width:900px;max-width:100%;border-radius:8px;padding:18px;box-shadow:0 10px 50px rgba(0,0,0,0.5);transform:translateY(-10px);opacity:0;transition:all .18s ease;max-height:95vh;overflow:auto}
    .modal.show{transform:none;opacity:1}
    .modal .modal-header{display:flex;align-items:center;gap:12px}
    .modal h2{margin:0}
    .right{margin-left:auto}

    /* Dual-receipt page layout inside modal */
    .dual-receipt{width:100%;display:block;color:#000}
    .receipt-half{padding:12px 8px;border:1px solid #ddd;margin-bottom:12px}
    .receipt-title{font-size:13px;color:#555;font-weight:700;margin-bottom:6px}
    .separator{border-top:2px dashed #999;margin:12px 0}

    /* Print rules: show only modal content; ensure 2 receipts on one page */
    @media print{
      :root{color-scheme:light}
      body{background:#fff;color:#000}
      body *{visibility:hidden}
      .modal, .modal *{visibility:visible}
      .modal{position:fixed;left:0;top:0;width:100%;height:100%;overflow:visible;border-radius:0;padding:8px}
      /* ensure both halves fit on a single A4 page in portrait */
      .dual-receipt{page-break-inside:avoid; width:100%}
      .receipt-half{border:none;margin:0;padding:8px}
      .modal .modal-header, .modal .right{visibility:visible}
    }

    .flex{display:flex;gap:8px;align-items:center}
    .muted-block{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <div id="logoPreview" class="logo">SI</div>
        <div>
          <h1 id="instituteName">Shiv Computer Institute</h1>
          <div id="instituteAddr" class="muted">123, Civil Lines, Kanpur • Mob: 9876543210 • info@shivcomputer.in</div>
        </div>
      </div>
      <div class="controls">
        <input id="logoUpload" type="file" accept="image/*" style="display:none">
        <button id="logoBtn" class="small">Upload Logo</button>
        <button id="exportBtn" class="small">Export JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <button id="importBtn" class="small">Import JSON</button>
      </div>
    </header>

    <main>
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Students</strong>
          <div class="flex">
            <select id="filterClass"><option value="">All Classes</option></select>
            <select id="filterSection"><option value="">All Sections</option></select>
            <input id="searchName" placeholder="Search name..." />
          </div>
        </div>

        <div style="overflow:auto;max-height:420px;margin-top:10px">
          <table id="studentsTable">
            <thead><tr><th></th><th>Student</th><th>Class</th><th>Section</th><th>Due</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:12px" class="card">
          <strong>Add / Edit Student & Payment</strong>
          <div style="margin-top:8px" class="form-row">
            <div>
              <label>Name</label>
              <input id="stuName">
            </div>
            <div>
              <label>Class</label>
              <select id="stuClass"></select>
            </div>
            <div>
              <label>Section</label>
              <select id="stuSection"></select>
            </div>
            <div>
              <label>Profile Photo</label>
              <input id="stuPhoto" type="file" accept="image/*">
            </div>
            <div>
              <label>Fee Type</label>
              <select id="feeType"><option value="Tuition">Tuition</option><option value="Exam">Exam</option><option value="Transport">Transport</option><option value="Other">Other</option></select>
            </div>
            <div>
              <label>Payment Mode</label>
              <select id="paymentMode"><option value="Cash">Cash</option><option value="UPI">UPI</option><option value="Bank">Bank</option><option value="Cheque">Cheque</option></select>
            </div>
            <div>
              <label>Month / Term</label>
              <input id="feeFor" placeholder="e.g., July 2025 or Term 1">
            </div>
            <div>
              <label>Amount Paid (₹)</label>
              <input id="paidAmount" type="number" min="0" value="0">
            </div>
            <div>
              <label>Payment Date</label>
              <input id="paidDate" type="date" />
            </div>
          </div>
          <div style="margin-top:8px" class="flex">
            <button id="saveStudent" class="small">Save & Receipt</button>
            <button id="clearForm" class="small">Clear</button>
            <button id="promoteBtn" class="small">Promote Selected</button>
            <button id="demoteBtn" class="small">Demote Selected</button>
          </div>
        </div>
      </section>

      <aside class="card dashboard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Dashboard</strong>
          <div class="badge" id="totalStudents">0 students</div>
        </div>

        <div class="cards" style="margin-top:10px">
          <div class="card"><div class="muted">Total Due</div><div id="totalDue" style="font-weight:700">₹0</div></div>
          <div class="card"><div class="muted">Monthly Due (approx)</div><div id="monthlyDue" style="font-weight:700">₹0</div></div>
        </div>

        <div style="margin-top:10px">
          <label>Institute Profile</label>
          <input id="instituteInputName" placeholder="Institute name">
          <input id="instituteInputAddr" placeholder="Address">
          <input id="instituteInputContact" placeholder="Mobile / Email">
          <div style="margin-top:8px" class="flex"><button id="saveSettings" class="small">Save Profile</button> <button id="printSample" class="small">Print Last Receipt</button></div>
        </div>

        <div style="margin-top:10px">
          <label>Sections (comma separated)</label>
          <input id="sectionsInput" placeholder="A,B,C">
          <div style="margin-top:8px" class="flex"><button id="saveSections" class="small">Save Sections</button> <button id="clearSections" class="small">Clear</button></div>
        </div>

        <div style="margin-top:10px">
          <label>Manage Fees (per class)</label>
          <select id="manageFeeClass"></select>
          <input id="manageFeeValue" placeholder="Monthly fee">
          <input id="manageExamValue" placeholder="Exam fee">
          <div style="margin-top:8px" class="flex"><button id="saveFee" class="small">Save Fee</button></div>
        </div>

        <div style="margin-top:10px">
          <label>Quick Actions</label>
          <input id="quickId" placeholder="Student id">
          <div style="margin-top:8px" class="flex"><button id="printReceiptBtn" class="small">Print Last Receipt</button> <button id="deleteBtn" class="small">Delete</button></div>
        </div>
      </aside>
    </main>

    <footer>Made for mobile & desktop — data stored in your browser. Export to backup.</footer>
  </div>

  <!-- Modal for centered A4-like dual receipt -->
  <div id="receiptModalBackdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div id="receiptModal" class="modal" role="document">
      <div class="modal-header">
        <div id="modalLogo" style="width:90px;height:90px;border-radius:10px;background:#eee;display:flex;align-items:center;justify-content:center">SI</div>
        <div>
          <h2 id="modalInstituteName">Institute</h2>
          <div id="modalInstituteAddr" style="font-size:13px;color:#333"></div>
        </div>
        <div class="right">
          <div>Receipt No: <span id="modalReceiptNo"></span></div>
          <div>Date: <span id="modalDate"></span></div>
        </div>
      </div>

      <hr style="margin:10px 0">

      <div id="modalBody">
        <!-- dual receipts injected here -->
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="modalPrint" class="small">Print</button>
        <button id="modalClose" class="small">Close</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const STORAGE_KEY = 'school_fee_manager_v6';
      const defaultClasses = ['Nursery','LKG','UKG',...Array.from({length:12},(_,i)=>String(i+1))];
      const $ = id => document.getElementById(id);
      function nid(){return 'S'+Date.now().toString(36).slice(0,9)}
      function fmt(n){return '₹'+Number(n||0).toLocaleString('en-IN')}
      function uidReceipt(){ return 'RCPT-'+(new Date().getTime()).toString(36).toUpperCase().slice(-8)}

      function defaultStore(){ return {
        institute:{name:'Shiv Computer Institute', addr:'123, Civil Lines, Kanpur', contact:'Mob: 9876543210 | info@shivcomputer.in', logo:null},
        classes: defaultClasses.map(c=>({name:c,fee:0,examFee:0})),
        sections:['A','B'],
        students:[], receipts:[], lastReceiptNo:0 } }

      let store = (function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return defaultStore(); return JSON.parse(raw) }catch(e){console.error(e); return defaultStore()} })();
      function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); renderAll(); }

      // logo, export, import
      $('logoBtn').addEventListener('click', ()=>$('logoUpload').click());
      $('logoUpload').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ store.institute.logo = r.result; save(); }; r.readAsDataURL(f); });
      $('exportBtn').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(store,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=(store.institute.name||'school')+'_backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });
      $('importBtn').addEventListener('click', ()=>$('importFile').click());
      $('importFile').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const j=JSON.parse(r.result); if(confirm('Replace current data with imported data?')){ store=j; save(); } }catch(err){alert('Invalid JSON')} }; r.readAsText(f); });

      // student photo handling
      let photoData = null; $('stuPhoto').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ photoData = r.result; }; r.readAsDataURL(f); });

      function renderAll(){
        // header
        $('instituteName').textContent = store.institute.name || '';
        $('instituteAddr').textContent = (store.institute.addr||'') + ' • ' + (store.institute.contact||'');
        const logoPreview = $('logoPreview'); if(store.institute.logo){ logoPreview.innerHTML = `<img src='${store.institute.logo}' style='width:64px;height:64px;border-radius:10px;object-fit:cover'/>`; logoPreview.style.background='transparent'; } else { logoPreview.innerHTML='SI'; logoPreview.style.background=''; }

        // classes -> selects
        const classTargets = [$('stuClass'), $('filterClass'), $('manageFeeClass')];
        classTargets.forEach(sel=>{ if(!sel) return; sel.innerHTML=''; const ph=document.createElement('option'); ph.value=''; ph.textContent = sel===$('filterClass')? 'All Classes' : '-- select class --'; sel.appendChild(ph); store.classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; sel.appendChild(o); }); });

        // sections
        const sectionTargets = [$('stuSection'), $('filterSection')];
        sectionTargets.forEach(sel=>{ if(!sel) return; sel.innerHTML=''; const ph=document.createElement('option'); ph.value=''; ph.textContent = sel===$('filterSection')? 'All Sections' : '-- select section --'; sel.appendChild(ph); store.sections.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); }); });

        // students table
        const tbody = document.querySelector('#studentsTable tbody'); if(!tbody) return; tbody.innerHTML='';
        const q = ($('searchName') && $('searchName').value.toLowerCase()) || '';
        const fc = $('filterClass')? $('filterClass').value : '';
        const fs = $('filterSection')? $('filterSection').value : '';
        store.students.filter(s=>{ if(fc && s.className!==fc) return false; if(fs && s.section!==fs) return false; if(q && !s.name.toLowerCase().includes(q)) return false; return true }).forEach(s=>{
          const tr=document.createElement('tr');
          const td0=document.createElement('td'); const cb=document.createElement('input'); cb.type='checkbox'; cb.value=s.id; td0.appendChild(cb);
          const td1=document.createElement('td'); td1.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><img class='thumb' src='${s.photo||''}' onerror="this.style.display='none'"/> <div><strong>${s.name}</strong><br><small>id: ${s.id}</small></div></div>`;
          const td2=document.createElement('td'); td2.textContent = s.className || '-';
          const td3=document.createElement('td'); td3.textContent = s.section || '-';
          const due = calcDueForStudent(s);
          const td4=document.createElement('td'); td4.textContent = fmt(due.totalDue);
          const td5=document.createElement('td'); td5.innerHTML = `<button data-id='${s.id}' data-act='view' class='small'>View</button> <button data-id='${s.id}' data-act='pay' class='small'>Pay</button> <button data-id='${s.id}' data-act='edit' class='small'>Edit</button> <button data-id='${s.id}' data-act='del' class='small'>Delete</button>`;
          tr.appendChild(td0); tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
          tbody.appendChild(tr);
        });

        // totals
        $('totalStudents').textContent = store.students.length + ' students';
        const totals = store.students.reduce((acc,s)=>{ const cls = store.classes.find(c=>c.name===s.className) || {fee:0,examFee:0}; const should = Number(cls.fee||0)+Number(cls.examFee||0); const paid = (s.payments||[]).reduce((a,p)=>a+Number(p.amount||0),0); acc.total += Math.max(0, should-paid); return acc }, {total:0});
        $('totalDue').textContent = fmt(totals.total);
      }

      function calcDueForStudent(s){ const cls = store.classes.find(c=>c.name===s.className) || {fee:0,examFee:0}; const totalShould = Number(cls.fee||0)+Number(cls.examFee||0); const paid = (s.payments||[]).reduce((a,p)=>a+Number(p.amount||0),0); return {totalShould,totalPaid:paid,totalDue:Math.max(0,totalShould-paid)} }

      // save student & create receipt -> show modal (dual receipts)
      let editingId = null;
      $('saveStudent').addEventListener('click', ()=>{
        const name = ($('stuName') && $('stuName').value.trim()) || '';
        const className = $('stuClass')? $('stuClass').value : '';
        const section = $('stuSection')? $('stuSection').value : '';
        const feeType = $('feeType')? $('feeType').value : 'Tuition';
        const paymentMode = $('paymentMode')? $('paymentMode').value : 'Cash';
        const feeFor = $('feeFor')? $('feeFor').value : '';
        const amount = Number($('paidAmount')? $('paidAmount').value : 0) || 0;
        const date = $('paidDate')? ($('paidDate').value || new Date().toISOString().slice(0,10)) : new Date().toISOString().slice(0,10);
        if(!name || !className) return alert('Please enter name and class');

        let studentId = editingId;
        if(editingId){ const s = store.students.find(x=>x.id===editingId); if(!s) return alert('Student not found'); s.name=name; s.className=className; s.section=section; if(photoData) s.photo=photoData; if(amount>0) s.payments.push({type:feeType,amount,date,mode:paymentMode,for:feeFor}); }
        else { studentId = nid(); const st = {id:studentId, name, className, section, photo:photoData||null, payments:[], created:new Date().toISOString()}; if(amount>0) st.payments.push({type:feeType,amount,date,mode:paymentMode,for:feeFor}); store.students.push(st); }

        // create receipt and show modal
        if(amount>0){ const rno = (store.lastReceiptNo||0)+1; store.lastReceiptNo = rno; const rec = {no:rno, id:uidReceipt(), studentId: studentId, studentName: name, className, section, feeType, amount, date, mode:paymentMode, for: feeFor}; store.receipts.push(rec); save(); showReceiptModalDual(rec); }
        else { save(); }

        photoData = null; if($('stuPhoto')) $('stuPhoto').value=''; clearForm();
      });

      function clearForm(){ if($('stuName')) $('stuName').value=''; if($('stuClass')) $('stuClass').value=''; if($('stuSection')) $('stuSection').value=''; if($('paidAmount')) $('paidAmount').value=0; if($('paidDate')) $('paidDate').value=''; if($('feeFor')) $('feeFor').value=''; if($('feeType')) $('feeType').value='Tuition'; if($('paymentMode')) $('paymentMode').value='Cash'; editingId=null; photoData=null; }
      $('clearForm').addEventListener('click', clearForm);

      // delegate table actions
      document.querySelector('#studentsTable tbody').addEventListener('click', (e)=>{
        const bt = e.target.closest('button'); if(!bt) return; const id = bt.dataset.id; const act = bt.dataset.act; const s = store.students.find(x=>x.id===id); if(!s) return;
        if(act==='view'){ alert(JSON.stringify(s,null,2)); }
        else if(act==='edit'){ editingId = s.id; if($('stuName')) $('stuName').value=s.name; if($('stuClass')) $('stuClass').value=s.className; if($('stuSection')) $('stuSection').value=s.section||''; photoData = s.photo||null; }
        else if(act==='del'){ if(confirm('Delete '+s.name+'?')){ store.students = store.students.filter(x=>x.id!==id); save(); } }
        else if(act==='pay'){ const amt = prompt('Enter amount'); if(!amt) return; const a = Number(amt); const m = prompt('Payment mode (Cash/UPI/Bank/Cheque)', 'Cash'); const d = new Date().toISOString().slice(0,10); s.payments.push({type:'Tuition',amount:a,date:d,mode:m,for:''}); const rno=(store.lastReceiptNo||0)+1; store.lastReceiptNo=rno; const rec={no:rno,id:uidReceipt(),studentId:s.id,studentName:s.name,className:s.className,section:s.section,feeType:'Tuition',amount:a,date:d,mode:m,for:''}; store.receipts.push(rec); save(); showReceiptModalDual(rec); }
      });

      // promote/demote
      $('promoteBtn').addEventListener('click', ()=>bulkPromote(true));
      $('demoteBtn').addEventListener('click', ()=>bulkPromote(false));
      function bulkPromote(up){ const ids = Array.from(document.querySelectorAll('#studentsTable tbody input[type=checkbox]:checked')).map(i=>i.value); if(ids.length===0) return alert('Select students using checkboxes'); ids.forEach(id=>{ const s=store.students.find(x=>x.id===id); if(!s) return; const idx=store.classes.findIndex(c=>c.name===s.className); if(idx<0) return; const newIdx=up? Math.min(store.classes.length-1,idx+1):Math.max(0,idx-1); s.className = store.classes[newIdx].name }); save(); }

      // search/filters
      if($('searchName')) $('searchName').addEventListener('input', renderAll);
      if($('filterClass')) $('filterClass').addEventListener('change', renderAll);
      if($('filterSection')) $('filterSection').addEventListener('change', renderAll);

      // profile settings
      $('saveSettings').addEventListener('click', ()=>{ store.institute.name = $('instituteInputName').value || store.institute.name; store.institute.addr = $('instituteInputAddr').value || store.institute.addr; store.institute.contact = $('instituteInputContact').value || store.institute.contact; save(); });

      // sections
      $('saveSections').addEventListener('click', ()=>{ const v = $('sectionsInput').value.split(',').map(s=>s.trim()).filter(Boolean); if(v.length) store.sections = v; save(); });
      $('clearSections').addEventListener('click', ()=>{ if(confirm('Clear sections?')){ store.sections=[]; save(); } });

      // manage fees
      $('saveFee').addEventListener('click', ()=>{ const cls = $('manageFeeClass').value; const f = Number($('manageFeeValue').value||0); const e = Number($('manageExamValue').value||0); const c = store.classes.find(x=>x.name===cls); if(!c) return alert('Select class'); c.fee = f; c.examFee = e; save(); });

      // quick actions
      $('deleteBtn').addEventListener('click', ()=>{ const id = $('quickId').value.trim(); if(!id) return alert('Enter id'); if(confirm('Delete '+id+'?')){ store.students = store.students.filter(x=>x.id!==id); save(); } });
      $('printReceiptBtn').addEventListener('click', ()=>{ const id = $('quickId').value.trim(); if(!id) return alert('Enter id'); const s = store.students.find(x=>x.id===id); if(!s) return alert('Not found'); const r = store.receipts.slice().reverse().find(rr=>rr.studentId===s.id); if(r) showReceiptModalDual(r); else alert('No receipt found for this student'); });

      // print last / sample
      $('printSample').addEventListener('click', ()=>{ if(store.receipts.length>0) showReceiptModalDual(store.receipts[store.receipts.length-1]); else if(store.students.length>0){ const s = store.students[0]; const lastPay = (s.payments && s.payments.length)? s.payments[s.payments.length-1] : {amount:0,date:new Date().toISOString().slice(0,10),mode:'Cash',type:'Tuition',for:''}; const rno=(store.lastReceiptNo||0)+1; store.lastReceiptNo=rno; const rec={no:rno,id:uidReceipt(),studentId:s.id,studentName:s.name,className:s.className,section:s.section,feeType:lastPay.type||'Tuition',amount:lastPay.amount||0,date:lastPay.date||new Date().toISOString().slice(0,10),mode:lastPay.mode||'Cash',for:lastPay.for||''}; store.receipts.push(rec); save(); showReceiptModalDual(rec);} else alert('No data to print'); });

      // modal control
      const backdrop = $('receiptModalBackdrop'); const modal = $('receiptModal'); const modalClose = $('modalClose'); const modalPrint = $('modalPrint');
      // close controls
      // modal close exists; we added id earlier as modalClose in earlier versions - ensure fallback
      const closeBtn = document.querySelector('#modalClose') || null;
      if(closeBtn){ closeBtn.addEventListener('click', ()=>{ backdrop.style.display='none'; modal.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); }); }
      backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop){ backdrop.style.display='none'; modal.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); } });
      // print button inside modal: we added id modalPrint
      const mp = document.querySelector('#modalPrint') || null;
      if(mp){ mp.addEventListener('click', ()=>{ window.print(); }); }

      // number to words
      function numberToWords(num){ if(!num) return 'Zero'; const a=['','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen']; const b=['','', 'twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety']; function inWords(n){ if(n<20) return a[n]; if(n<100) return b[Math.floor(n/10)] + (n%10? ' '+a[n%10]: ''); if(n<1000) return a[Math.floor(n/100)] + ' hundred' + (n%100? ' and '+ inWords(n%100): ''); return '' } let str=''; if(num>=10000000){ str += inWords(Math.floor(num/10000000)) + ' crore '; num = num%10000000 } if(num>=100000){ str += inWords(Math.floor(num/100000)) + ' lakh '; num = num%100000 } if(num>=1000){ str += inWords(Math.floor(num/1000)) + ' thousand '; num = num%1000 } if(num>0) str += inWords(num); return str.trim(); }

      // show dual receipt in modal
      function buildSingleReceiptHTML(copyTitle, r, student){
        const cls = store.classes.find(c=>c.name===student.className) || {fee:0,examFee:0};
        const totalShould = Number(cls.fee||0) + Number(cls.examFee||0);
        const balance = Math.max(0, totalShould - Number(r.amount||0));
        // student photo html
        const photoHtml = student.photo? `<img src="${student.photo}" style="width:70px;height:70px;object-fit:cover;border-radius:6px;border:1px solid #ccc">` : `<div style="width:70px;height:70px;background:#eee;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#666">No Photo</div>`;
        return `
          <div class="receipt-half">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="display:flex;gap:12px;align-items:center">
                ${store.institute.logo? `<img src="${store.institute.logo}" style="width:70px;height:70px;object-fit:cover;border-radius:8px">` : `<div style="width:70px;height:70px;background:#eee;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700">SI</div>`}
                <div>
                  <div style="font-weight:700">${store.institute.name}</div>
                  <div style="font-size:12px;color:#444">${store.institute.addr}</div>
                  <div style="font-size:12px;color:#444">${store.institute.contact}</div>
                </div>
              </div>
              <div style="text-align:right">
                <div style="font-size:12px;color:#555">${copyTitle}</div>
                <div style="font-weight:700;margin-top:6px">Receipt: ${r.id}</div>
                <div style="font-size:13px;color:#333">Date: ${r.date}</div>
              </div>
            </div>

            <hr style="margin:8px 0;color:#ccc">

            <div style="display:flex;gap:12px;align-items:center">
              ${photoHtml}
              <div style="flex:1">
                <div><strong>Student:</strong> ${student.name}</div>
                <div><strong>ID:</strong> ${student.id}</div>
                <div><strong>Class:</strong> ${student.className} &nbsp; <strong>Section:</strong> ${student.section|| '-'}</div>
              </div>
            </div>

            <table style="width:100%;margin-top:8px;border-collapse:collapse;color:#000">
              <tbody>
                <tr><td style="padding:6px"><strong>Fee For</strong></td><td style="padding:6px">${r.for || '-'}</td><td style="padding:6px"><strong>Fee Type</strong></td><td style="padding:6px">${r.feeType}</td></tr>
                <tr><td style="padding:6px"><strong>Payment Mode</strong></td><td style="padding:6px">${r.mode}</td><td style="padding:6px"><strong>Paid Amount</strong></td><td style="padding:6px;text-align:right">${fmt(r.amount)}</td></tr>
                <tr><td style="padding:6px"><strong>Total (class+exam)</strong></td><td style="padding:6px">${fmt(totalShould)}</td><td style="padding:6px"><strong>Balance</strong></td><td style="padding:6px;text-align:right">${fmt(balance)}</td></tr>
              </tbody>
            </table>

            <div style="margin-top:8px"><strong>Amount (in words):</strong> ${numberToWords(Number(r.amount||0))} rupees only.</div>

            <div style="display:flex;justify-content:space-between;margin-top:18px">
              <div style="text-align:left">
                <div>__________________________</div>
                <div style="font-size:13px;color:#444">Receiver Signature</div>
              </div>
              <div style="text-align:right">
                <div>__________________________</div>
                <div style="font-size:13px;color:#444">Authorized Signature</div>
              </div>
            </div>
          </div>
        `;
      }

      function showReceiptModalDual(r){
        if(!r) return alert('Receipt data missing');
        const student = store.students.find(s=>s.id===r.studentId) || {name:r.studentName||'', className:r.className||'', section:r.section||'', photo:null, id:r.studentId||''};

        // build two copies: Institute + Student
        const top = buildSingleReceiptHTML('INSTITUTE COPY', r, student);
        const bottom = buildSingleReceiptHTML('STUDENT COPY', r, student);

        // put them into modalBody with separator
        const modalBody = $('modalBody');
        modalBody.innerHTML = `<div class="dual-receipt">${top}<div class="separator"></div>${bottom}</div>`;

        // header details
        $('modalInstituteName').textContent = store.institute.name || '';
        $('modalInstituteAddr').textContent = (store.institute.addr||'') + ' • ' + (store.institute.contact||'');
        $('modalReceiptNo').textContent = r.id || ('RCPT-'+String(r.no).padStart(5,'0'));
        $('modalDate').textContent = r.date || new Date().toISOString().slice(0,10);
        $('modalLogo').innerHTML = store.institute.logo? `<img src='${store.institute.logo}' style='width:90px;height:90px;object-fit:cover;border-radius:10px'/>` : `<div style='width:90px;height:90px;background:#eee;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700'>SI</div>`;

        // show modal
        backdrop.style.display = 'flex'; setTimeout(()=>{ modal.classList.add('show'); backdrop.setAttribute('aria-hidden','false'); }, 10);
      }

      // initial seed for test
      if(store.students.length===0){
        const s1={id:nid(), name:'Aarav', className:store.classes[3].name, section:store.sections[0], photo:null, payments:[{type:'Tuition',amount:1500,date:new Date().toISOString().slice(0,10),mode:'Cash',for:'July 2025'}], created:new Date().toISOString()};
        store.students.push(s1);
        const rno=(store.lastReceiptNo||0)+1; store.lastReceiptNo=rno;
        store.receipts.push({no:rno,id:uidReceipt(),studentId:s1.id,studentName:s1.name,className:s1.className,section:s1.section,feeType:'Tuition',amount:1500,date:new Date().toISOString().slice(0,10),mode:'Cash',for:'July 2025'});
        save();
      }

      renderAll();
    });
  </script>
</body>
</html>
