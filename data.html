<!DOCTYPE html>
<html>
<head>
    <title>Data Entry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="icon" type="image/png" href="SHIV.png">
    
    <script src="https://raw.githack.com/js-wac/jsPDF-Devanagari-Font/main/NotoSansDevanagari.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* Form and Action Area styles (рдЕрдкрд░рд┐рд╡рд░реНрддрд┐рдд) */
        .form-fields { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1 1 23%; min-width: 200px; } 
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #photo { padding: 5px; }

        .action-area { display: flex; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .action-area button { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s; 
        }
        
        .action-area button:hover {
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
        }

        #saveBtn, #updateBtn { background-color: #28a745; color: white; } /* Save/Update Button */
        #saveBtn:hover, #updateBtn:hover { background-color: #1e7e34; }
        #clearFormBtn { background-color: #f0ad4e; color: white; } 
        #clearFormBtn:hover { background-color: #ec971f; }
        #printBtn { background-color: #007bff; color: white; }
        #printBtn:hover { background-color: #0056b3; }
        #pdfBtn { background-color: #dc3545; color: white; } 
        #pdfBtn:hover { background-color: #c82333; }
        #excelBtn { background-color: #ffc107; color: #333; } 
        #excelBtn:hover { background-color: #e0a800; }
        #resetBtn { background-color: #6c757d; color: white; } 
        #resetBtn:hover { background-color: #5a6268; }
        
        #printIDCardBtn { background-color: #3f51b5; color: white; }
        #printIDCardBtn:hover { background-color: #303f9f; }
        
        /* Edit Button Style */
        .edit-btn { 
            background-color: #f0ad4e; 
            color: white; 
            padding: 5px 10px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px;
        }
        .edit-btn:hover { background-color: #ec971f; }

        .filter-area { margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        .filter-area label { font-weight: bold; color: #333; }
        .filter-area select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; }


        /* Table Style */
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #007bff; color: white; }
        
        #dataTable th:nth-child(2), #dataTable td:nth-child(2) { width: 4%; text-align: center; } 
        #dataTable th:nth-child(1), #dataTable td:nth-child(1) { width: 4%; text-align: center; } 
        #dataTable th:last-child, #dataTable td:last-child { width: 5%; text-align: center; } /* Edit Column Width */
        
        .photo-column img {
            width: 50px; 
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* --- ID Card Print Area Styles (Previous Optimization) --- */
        .id-card-print-container {
            display: none; 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            padding: 15px; 
            box-sizing: border-box;
        }
        .id-card {
            width: 185px; 
            height: 308px; /* 3 рд░реЛ рдХреЛ рдкреВрд░реЗ рдкреЗрдЬ рдкрд░ рдлрд┐рдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХрддрдо рдКрдБрдЪрд╛рдИ */
            border: 1px solid #007bff;
            border-radius: 8px;
            padding: 8px; 
            margin: 5px; 
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            float: left; 
            font-size: 9px; 
            box-sizing: border-box;
            background: #f0f8ff;
            text-align: left; 
        }
        /* ... (rest of the card styles are the same) ... */
        .id-card h3 {
            text-align: center;
            margin: 5px 0 8px 0; 
            color: #007bff;
            border-bottom: 1px dashed #ccc;
            font-size: 13px; 
        }
        .card-photo {
            width: 70px; 
            height: 90px; 
            border: 1px solid #ccc;
            overflow: hidden;
            margin: 0 auto 8px auto; 
        }
        .card-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .card-details-text p {
            margin: 2px 0;
            line-height: 1.1;
            padding-left: 3px; 
        }
        .card-details-text strong {
            display: inline-block;
            width: 60px; 
        }
        .barcode-area {
            text-align: center;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #ddd;
            width: 100%; 
        }
        .barcode-area svg {
            width: 100%; 
            height: 35px;
            display: block; 
        }
        .barcode-id-text {
            font-size: 8px;
            margin: 0;
            font-weight: bold;
            color: #555;
            text-transform: uppercase;
        }

        /* --- Print Styles (4 рдХреЙрд▓рдо, 3 рд░реЛ, рдиреНрдпреВрдирддрдо рдорд╛рд░реНрдЬрд┐рди) --- */
        @media print {
            body > *:not(.id-card-print-container) { 
                display: none !important; 
            }
            
            .id-card-print-container {
                display: grid !important; 
                grid-template-columns: repeat(4, 1fr); 
                grid-auto-rows: 308px;
                gap: 2px;
                position: static;
                padding: 0;
                margin: 0;
                width: 100%;
                height: auto;
                background: white;
            }
            
            @page {
                size: A4 portrait; 
                margin: 0.1cm;
            }

            .id-card {
                width: 100%; 
                height: 100%; 
                margin: 0;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

<div class="container hide-on-print">
    
    <h2>1. рдирдпрд╛ рд░рд┐рдХреЙрд░реНрдб рдПрдВрдЯрд░ рдХрд░реЗрдВ / рдПрдбрд┐рдЯ рдХрд░реЗрдВ</h2>
    
    <form id="recordForm">
        <input type="hidden" id="recordId" value=""> 

        <div class="form-fields">
            <div class="form-group"><label for="name">рдирд╛рдо:</label><input type="text" id="name" required></div>
            <div class="form-group"><label for="fatherName">рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо:</label><input type="text" id="fatherName" required></div>
            <div class="form-group"><label for="motherName">рдорд╛рддрд╛ рдХрд╛ рдирд╛рдо:</label><input type="text" id="motherName" required></div>
            <div class="form-group"><label for="mobile">рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░:</label><input type="text" id="mobile" required></div>
            <div class="form-group"><label for="address">рдкрддрд╛:</label><input type="text" id="address" required></div>
            <div class="form-group"><label for="class">рдХрдХреНрд╖рд╛:</label><input type="text" id="class" required></div>
            <div class="form-group"><label for="pen">PEN:</label><input type="text" id="pen" required></div>
            <div class="form-group"><label for="photo">рдлреЛрдЯреЛ рдЕрдЯреИрдЪ рдХрд░реЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ):</label><input type="file" id="photo" accept="image/*"></div>
        </div>

        <div class="action-area">
            <button type="submit" id="saveBtn">рдбреЗрдЯрд╛ рд╕реЗрд╡ рдХрд░реЗрдВ ЁЯТ╛</button> 
            <button type="button" id="updateBtn" style="display:none;">рдбреЗрдЯрд╛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ тЬЕ</button> 
            <button type="button" id="clearFormBtn">рдлрд╝реЙрд░реНрдо рдХреНрд▓рд┐рдпрд░ рдХрд░реЗрдВ ЁЯз╣</button> 
        </div>
    </form>

    <hr style="margin: 30px 0;">

    <h2>2. рд╕реЗрд╡ рдХрд┐рдпрд╛ рд╣реБрдЖ рдбреЗрдЯрд╛</h2>

    <div class="filter-area">
        <label for="classFilter">рдХреНрд▓рд╛рд╕ рджреНрд╡рд╛рд░рд╛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░реЗрдВ:</label>
        <select id="classFilter">
            <option value="all">рд╕рднреА рдХреНрд▓рд╛рд╕</option>
        </select>
    </div>

    <div class="action-area">
        <button id="printIDCardBtn">рдЪреБрдирд╛ рд╣реБрдЖ ID рдХрд╛рд░реНрдб рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдВ ЁЯкк</button>
        <button id="printBtn">рдкреВрд░рд╛ рдЯреЗрдмрд▓ рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдВ ЁЯЦия╕П</button>
        <button id="pdfBtn">PDF реЮрд╛рдЗрд▓ рдмрдирд╛рдПрдБ ЁЯУД</button>
        <button id="excelBtn">Excel реЮрд╛рдЗрд▓ рдмрдирд╛рдПрдБ (CSV) ЁЯУК</button>
        <button id="resetBtn">рд╕рд╛рд░рд╛ рдбреЗрдЯрд╛ рдбрд┐рд▓реАрдЯ рдХрд░реЗрдВ ЁЯЧСя╕П</button>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
                <th>рдХреНрд░. рд╕рдВ.</th> 
                <th>рдЪреБрдиреЗрдВ</th>
                <th>рдлреЛрдЯреЛ</th>
                <th>рдирд╛рдо</th>
                <th>рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо</th>
                <th>рдорд╛рддрд╛ рдХрд╛ рдирд╛рдо</th>
                <th>рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░</th>
                <th>рдкрддрд╛</th>
                <th>рдХрдХреНрд╖рд╛</th>
                <th>PEN</th>
                <th>рдПрдХреНрд╢рди</th> 
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
    <p id="loadingStatus" style="text-align: center; color: #007bff; display: none;">рдбреЗрдЯрд╛ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ... рдХреГрдкрдпрд╛ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВред</p>
</div>

<div class="id-card-print-container" id="idCardPrintContainer">
    </div>

<script>
    const DB_NAME = 'StudentDataDB';
    const STORE_NAME = 'records';
    let db; 
    let editingRecord = null; // To store the ID of the record being edited

    const form = document.getElementById('recordForm');
    const dataTableBody = document.getElementById('dataTable').querySelector('tbody');
    const classFilter = document.getElementById('classFilter');
    const loadingStatus = document.getElementById('loadingStatus');
    const idCardPrintContainer = document.getElementById('idCardPrintContainer');
    const recordIdInput = document.getElementById('recordId');
    const saveBtn = document.getElementById('saveBtn');
    const updateBtn = document.getElementById('updateBtn');

    // --- IndexedDB Setup ---

    function openDB() {
        return new Promise((resolve, reject) => {
            if (db) {
                resolve(db);
                return;
            }
            
            const request = indexedDB.open(DB_NAME, 1);
            request.onerror = (event) => {
                console.error("IndexedDB Error:", event.target.error);
                reject("IndexedDB рдЦреЛрд▓рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐ рд╣реБрдИред");
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            };
        });
    }

    function getStore(mode) {
        return new Promise(async (resolve, reject) => {
            try {
                const dbInstance = await openDB();
                const transaction = dbInstance.transaction(STORE_NAME, mode);
                transaction.onerror = (event) => reject(event.target.error);
                resolve(transaction.objectStore(STORE_NAME));
            } catch (error) {
                reject(error);
            }
        });
    }

    async function getAllRecordsFromDB() {
        try {
            const store = await getStore('readonly');
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.error("Fetch Error:", error);
            return [];
        }
    }
    
    async function getRecordById(id) {
        try {
            const store = await getStore('readonly');
            return new Promise((resolve, reject) => {
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.error("Fetch by ID Error:", error);
            return null;
        }
    }


    // --- рдбреЗрдЯрд╛ рдбрд┐рд╕реНрдкреНрд▓реЗ рдФрд░ рдлреЙрд░реНрдо рд╣реИрдВрдбрд▓рд┐рдВрдЧ ---

    function populateClassFilter(records) {
        const uniqueClasses = [...new Set(records.map(record => record.class))].sort();
        const currentSelection = classFilter.value; 
        
        classFilter.innerHTML = '<option value="all">рд╕рднреА рдХреНрд▓рд╛рд╕</option>'; 
        
        uniqueClasses.forEach(className => {
            if (className) {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            }
        });

        classFilter.value = currentSelection;
    }


    async function loadAndDisplayData() {
        loadingStatus.style.display = 'block';
        const allRecords = await getAllRecordsFromDB();
        
        populateClassFilter(allRecords); 
        
        const selectedClass = classFilter.value;

        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        dataTableBody.innerHTML = ''; 

        filteredRecords.forEach((record, index) => {
            const row = dataTableBody.insertRow();
            row.insertCell().textContent = index + 1; 

            const checkboxCell = row.insertCell();
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.classList.add('record-checkbox');
            checkbox.value = record.id; 
            checkboxCell.appendChild(checkbox);
            
            const photoCell = row.insertCell();
            photoCell.classList.add('photo-column');
            if (record.photoBase64) {
                const img = document.createElement('img');
                img.src = record.photoBase64;
                img.alt = "рд╕реНрдЯреВрдбреЗрдВрдЯ рдлреЛрдЯреЛ";
                photoCell.appendChild(img);
            } else {
                photoCell.textContent = 'N/A';
            }

            row.insertCell().textContent = record.name;
            row.insertCell().textContent = record.fatherName;
            row.insertCell().textContent = record.motherName;
            row.insertCell().textContent = record.mobile;
            row.insertCell().textContent = record.address;
            row.insertCell().textContent = record.class;
            row.insertCell().textContent = record.pen;
            
            // New Action/Edit Column
            const actionCell = row.insertCell();
            const editButton = document.createElement('button');
            editButton.textContent = 'рдПрдбрд┐рдЯ рдХрд░реЗрдВ тЬПя╕П';
            editButton.classList.add('edit-btn');
            editButton.dataset.id = record.id;
            editButton.onclick = () => loadRecordForEdit(record.id);
            actionCell.appendChild(editButton);
        });

        loadingStatus.style.display = 'none';
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            if (!file) {
                resolve(null);
                return;
            }
            if (file.size > 2 * 1024 * 1024) {
                alert("рдЪреЗрддрд╛рд╡рдиреА: рдлреЛрдЯреЛ 2MB рд╕реЗ рдмрдбрд╝реА рд╣реИред рдпрд╣ IndexedDB рдореЗрдВ рд▓реЛрдб рд╣реЛрдиреЗ рдореЗрдВ рд╕рдордп рд▓реЗ рд╕рдХрддреА рд╣реИред");
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    
    function setFormMode(isEditing) {
        if (isEditing) {
            saveBtn.style.display = 'none';
            updateBtn.style.display = 'inline-block';
        } else {
            saveBtn.style.display = 'inline-block';
            updateBtn.style.display = 'none';
            recordIdInput.value = ''; // Clear ID for new record
            editingRecord = null;
        }
    }
    
    async function loadRecordForEdit(id) {
        const record = await getRecordById(id);
        if (record) {
            document.getElementById('name').value = record.name;
            document.getElementById('fatherName').value = record.fatherName;
            document.getElementById('motherName').value = record.motherName;
            document.getElementById('mobile').value = record.mobile;
            document.getElementById('address').value = record.address;
            document.getElementById('class').value = record.class;
            document.getElementById('pen').value = record.pen;
            
            // Store ID and set editing mode
            recordIdInput.value = record.id;
            editingRecord = record; // Store the entire record for comparison (optional)
            setFormMode(true);
            
            // Scroll to the top of the form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            alert("рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рдорд┐рд▓рд╛ред");
        }
    }

    async function saveOrUpdateRecord(event) {
        event.preventDefault(); 
        
        const photoFile = document.getElementById('photo').files[0];
        let photoBase64 = null;
        
        if (photoFile) {
            // New photo uploaded
            photoBase64 = await fileToBase64(photoFile); 
        } else if (editingRecord && editingRecord.photoBase64) {
            // Retain old photo if not uploading new one
            photoBase64 = editingRecord.photoBase64;
        }


        const newRecordData = {
            name: document.getElementById('name').value,
            fatherName: document.getElementById('fatherName').value,
            motherName: document.getElementById('motherName').value,
            mobile: document.getElementById('mobile').value,
            address: document.getElementById('address').value,
            class: document.getElementById('class').value,
            pen: document.getElementById('pen').value,
            photoBase64: photoBase64 
        };
        
        const recordId = recordIdInput.value;
        const isEditing = recordId !== '';

        if (isEditing) {
            // Update an existing record
            newRecordData.id = parseInt(recordId); // ID must be kept for update
            try {
                const store = await getStore('readwrite');
                const request = store.put(newRecordData); // put() updates if ID exists, adds otherwise
                
                request.onsuccess = () => {
                    form.reset();
                    setFormMode(false); // Switch back to save mode
                    loadAndDisplayData();
                    alert("рд░рд┐рдХреЙрд░реНрдб рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЕрдкрдбреЗрдЯ рд╣реЛ рдЧрдпрд╛! тЬЕ");
                };

                request.onerror = (event) => {
                    alert(`рдбреЗрдЯрд╛ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐: ${event.target.error}`);
                };

            } catch (error) {
                alert(`рдбреЗрдЯрд╛рдмреЗрд╕ рддреНрд░реБрдЯрд┐: ${error}`);
            }
            
        } else {
            // Save a new record
            try {
                const store = await getStore('readwrite');
                const request = store.add(newRecordData);
                
                request.onsuccess = () => {
                    form.reset();
                    loadAndDisplayData();
                    alert("рд░рд┐рдХреЙрд░реНрдб IndexedDB рдореЗрдВ рд╕реЗрд╡ рд╣реЛ рдЧрдпрд╛! ЁЯТ╛");
                };

                request.onerror = (event) => {
                    alert(`рдбреЗрдЯрд╛ рд╕реЗрд╡ рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐: ${event.target.error}`);
                };

            } catch (error) {
                alert(`рдбреЗрдЯрд╛рдмреЗрд╕ рддреНрд░реБрдЯрд┐: ${error}`);
            }
        }
    }
    
    function clearForm() {
        form.reset();
        setFormMode(false); // Ensure it reverts to Save mode
        alert("рдлрд╝реЙрд░реНрдо рдлрд╝реАрд▓реНрдбреНрд╕ рдХреНрд▓рд┐рдпрд░ рдХрд░ рджрд┐рдП рдЧрдП рд╣реИрдВред");
    }

    // ***** рдпрд╣ рдлрдВрдХреНрд╢рди рдкрд╛рд╕рд╡рд░реНрдб рдЪреЗрдХ рдХреЗ рд╕рд╛рде рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ *****
    function resetData() {
        const password = prompt("рдбреЗрдЯрд╛ рдбрд┐рд▓реАрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╛рд╕рд╡рд░реНрдб рдбрд╛рд▓реЗрдВ:");
        const requiredPassword = '851556'; // рдЖрдкрдХрд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдкрд╛рд╕рд╡рд░реНрдб
        
        if (password === requiredPassword) {
            const confirmReset = confirm("рдкрд╛рд╕рд╡рд░реНрдб рд╕рд╣реА рд╣реИред рдХреНрдпрд╛ рдЖрдк рд╡рд╛рдХрдИ IndexedDB рд╕реЗ рд╕рднреА рд░рд┐рдХреЙрд░реНрдб рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╣ рдХрд╛рд░реНрд░рд╡рд╛рдИ рд╡рд╛рдкрд╕ рдирд╣реАрдВ рд▓реА рдЬрд╛ рд╕рдХрддреАред");
            
            if (confirmReset) {
                try {
                    const request = indexedDB.deleteDatabase(DB_NAME);
                    request.onsuccess = () => {
                        db = null; 
                        loadAndDisplayData(); 
                        alert("рд╕рднреА рд░рд┐рдХреЙрд░реНрдб рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдбрд┐рд▓реАрдЯ рдХрд░ рджрд┐рдП рдЧрдП рд╣реИрдВред");
                    };
                    request.onerror = (event) => {
                        alert(`рдбреЗрдЯрд╛рдмреЗрд╕ рдбрд┐рд▓реАрдЯ рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐: ${event.target.error}`);
                    };
                } catch(error) {
                     alert(`рдбреЗрдЯрд╛рдмреЗрд╕ рддреНрд░реБрдЯрд┐: ${error}`);
                }
            } else {
                alert("рдбреЗрдЯрд╛ рдбрд┐рд▓реАрдЯ рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд░рджреНрдж рдХрд░ рджреА рдЧрдИред");
            }
        } else if (password !== null) {
            alert("рдкрд╛рд╕рд╡рд░реНрдб рдЧрд▓рдд рд╣реИред рдбреЗрдЯрд╛ рдбрд┐рд▓реАрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ред");
        } else {
            alert("рдбреЗрдЯрд╛ рдбрд┐рд▓реАрдЯ рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд░рджреНрдж рдХрд░ рджреА рдЧрдИред");
        }
    }
    // *******************************************************
    
    // --- Export/Print Functions (Unchanged) ---
    
    function printTable() {
        window.print(); 
    }

    async function exportPDF() {
        // PDF рдПрдХреНрд╕рдкреЛрд░реНрдЯ рд▓реЙрдЬрд┐рдХ (Unchanged)
        const allRecords = await getAllRecordsFromDB();
        const selectedClass = classFilter.value;
        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        if (filteredRecords.length === 0) {
            alert("PDF рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВ рд╣реИ!");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'pt', 'a4'); 
        doc.setFont('NotoSansDevanagari', 'normal');

        const head = [["рдХреНрд░. рд╕рдВ.", "рдлреЛрдЯреЛ", "рдирд╛рдо", "рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо", "рдорд╛рддрд╛ рдХрд╛ рдирд╛рдо", "рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░", "рдкрддрд╛", "рдХрдХреНрд╖рд╛", "PEN"]];
        
        const body = filteredRecords.map((record, index) => [
            index + 1, 
            '', 
            record.name,
            record.fatherName,
            record.motherName,
            record.mobile,
            record.address,
            record.class,
            record.pen
        ]);

        doc.autoTable({ 
            head: head,
            body: body,
            startY: 40,
            headStyles: { fillColor: [0, 123, 255], font: 'NotoSansDevanagari', minCellHeight: 20 }, 
            styles: { font: 'NotoSansDevanagari', halign: 'left', fontSize: 8, cellPadding: 3, minCellHeight: 30 },
            columnStyles: {
                0: { cellWidth: 25 }, 
                1: { cellWidth: 35, halign: 'center' } 
            },
            didDrawCell: function(data) {
                if (data.section === 'body' && data.column.index === 1 && filteredRecords[data.row.index].photoBase64) {
                    const photoBase64 = filteredRecords[data.row.index].photoBase64;
                    const margin = 2;
                    doc.addImage(
                        photoBase64, 
                        'JPEG', 
                        data.cell.x + margin, 
                        data.cell.y + margin, 
                        data.cell.width - (margin * 2), 
                        data.cell.height - (margin * 2) 
                    );
                }
            },
            didDrawPage: function(data) {
                doc.setFont('NotoSansDevanagari', 'normal');
                const titleText = selectedClass === 'all' ? 
                                  "рд╕реЗрд╡ рдХрд┐рдП рдЧрдП рд╕рднреА рд░рд┐рдХреЙрд░реНрдбреНрд╕ рдХрд╛ рдбреЗрдЯрд╛" : 
                                  `рдХреНрд▓рд╛рд╕ ${selectedClass} рдХреЗ рд░рд┐рдХреЙрд░реНрдбреНрд╕ рдХрд╛ рдбреЗрдЯрд╛`;
                doc.text(titleText, 40, 30);
            }
        });
        
        doc.save('Student_Records_PDF.pdf');
    }

    async function exportCSV() {
        // CSV рдПрдХреНрд╕рдкреЛрд░реНрдЯ рд▓реЙрдЬрд┐рдХ (Unchanged)
        const allRecords = await getAllRecordsFromDB();
        const selectedClass = classFilter.value;
        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        if (filteredRecords.length === 0) {
            alert("рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВ рд╣реИ!");
            return;
        }

        const headers = ["рдХреНрд░. рд╕рдВ.", "рдирд╛рдо", "рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо", "рдорд╛рддрд╛ рдХрд╛ рдирд╛рдо", "рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░", "рдкрддрд╛", "рдХрдХреНрд╖рд╛", "PEN"];
        
        let csv = headers.join(',') + '\n';
        
        filteredRecords.forEach((record, index) => {
            const row = [
                index + 1, 
                record.name,
                record.fatherName,
                record.motherName,
                record.mobile,
                record.address,
                record.class,
                record.pen
            ].map(item => {
                let cleanItem = String(item).replace(/"/g, '""'); 
                return `"${cleanItem}"`; 
            }).join(','); 
            
            csv += row + '\n';
        });

        const BOM = "\uFEFF"; 
        const finalCSV = BOM + csv;
        
        const filename = selectedClass === 'all' ? 
                         'Student_Records_All_Classes.csv' : 
                         `Student_Records_Class_${selectedClass}.csv`;

        const blob = new Blob([finalCSV], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("Excel/CSV реЮрд╛рдЗрд▓ рдореЗрдВ рдлреЛрдЯреЛ рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реЛрдЧреАред");
    }


    // --- ID Card Print Function (Unchanged) ---
    
    function generateIDCardHTML(record) {
        const photoSrc = record.photoBase64 || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="#ddd"/><text x="50" y="55" font-size="20" text-anchor="middle" fill="#555">No Photo</text></svg>';

        return `
            <div class="id-card">
                <h3>рд╢реНрд░реА рджреБрд░реНрдЧреЗ рдорд╛рдБ рдмрд╛рд▓ рдЧреЛрд╡рд┐рдиреНрдж рдЗрдгреНрдЯрд░ рдХрд╛рд▓реЗрдЬ </h3>
                <div class="card-photo">
                    <img src="${photoSrc}" alt="Student Photo">
                </div>
                <div class="card-details-text">
                    <p><strong>рдирд╛рдо:</strong> ${record.name}</p>
                    <p><strong>рдХрдХреНрд╖рд╛:</strong> ${record.class}</p>
                    <p><strong>рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо:</strong> ${record.fatherName}</p>
                    <p><strong>рдорд╛рддрд╛ рдХрд╛ рдирд╛рдо:</strong> ${record.motherName}</p>
                    <p><strong>рдореЛрдмрд╛рдЗрд▓:</strong> ${record.mobile}</p>
                    <p><strong>PEN:</strong> ${record.pen}</p>
                    <p><strong>рдкрддрд╛:</strong> ${record.address}</p>
                </div>
                <div class="barcode-area">
                    <svg id="barcode-${record.id}"></svg>
                    <p class="barcode-id-text">ID: ${record.id}</p>
                </div>
            </div>
        `;
    }

    async function printSelectedIDCards() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.record-checkbox:checked'));
        
        if (selectedCheckboxes.length === 0) {
            alert("рдХреГрдкрдпрд╛ ID рдХрд╛рд░реНрдб рдкреНрд░рд┐рдВрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдо рд╕реЗ рдХрдо рдПрдХ рдкрдВрдХреНрддрд┐ (Checkbox) рдЪреБрдиреЗрдВред");
            return;
        }

        const selectedIds = selectedCheckboxes.map(cb => parseInt(cb.value, 10));
        const allRecords = await getAllRecordsFromDB();
        
        const selectedRecords = allRecords.filter(record => selectedIds.includes(record.id));

        if (selectedRecords.length === 0) {
            alert("рдЪреБрдиреЗ рдЧрдП рд░рд┐рдХреЙрд░реНрдбреНрд╕ рдХрд╛ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВ рдорд┐рд▓рд╛ред");
            return;
        }

        // 1. HTML рдЬреЗрдирд░реЗрдЯ рдХрд░реЗрдВ рдФрд░ DOM рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ
        idCardPrintContainer.innerHTML = '';
        selectedRecords.forEach(record => {
            idCardPrintContainer.innerHTML += generateIDCardHTML(record);
        });

        // 2. DOM рдореЗрдВ HTML рдЬреБрдбрд╝рдиреЗ рдХреЗ рдмрд╛рдж, рдмрд╛рд░рдХреЛрдб рдЬреЗрдирд░реЗрдЯ рдХрд░реЗрдВ (рдмрд╛рд░рдХреЛрдб рдХреЗрд╡рд▓ ID рдХреЛ рдПрдиреНрдХреЛрдб рдХрд░рддрд╛ рд╣реИ)
        selectedRecords.forEach(record => {
            const barcodeElement = document.getElementById(`barcode-${record.id}`);
            if (barcodeElement) {
                JsBarcode(barcodeElement, String(record.id), {
                    format: "CODE128", 
                    displayValue: false, 
                    margin: 0,
                    width: 1.5, // рдмрд╛рд░рдХреЛрдб рдХреА рдЪреМрдбрд╝рд╛рдИ
                    height: 35, // рдмрд╛рд░рдХреЛрдб рдХреА рдКрдБрдЪрд╛рдИ
                    background: "#f0f8ff"
                });
            }
        });

        // 3. рдкреНрд░рд┐рдВрдЯ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдВред
        window.print();
        
        // 4. рдкреНрд░рд┐рдВрдЯ рдХреЗ рдмрд╛рдж рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
        setTimeout(() => {
            idCardPrintContainer.innerHTML = '';
        }, 500); 
    }


    // --- рдЗрд╡реЗрдВрдЯ рд▓рд┐рд╕рдирд░ ---
    document.getElementById('printIDCardBtn').addEventListener('click', printSelectedIDCards); 
    document.getElementById('printBtn').addEventListener('click', printTable);
    document.getElementById('pdfBtn').addEventListener('click', exportPDF);
    document.getElementById('excelBtn').addEventListener('click', exportCSV);
    document.getElementById('resetBtn').addEventListener('click', resetData);
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);
    
    // Use a unified function for Save/Update
    form.addEventListener('submit', saveOrUpdateRecord); 
    updateBtn.addEventListener('click', saveOrUpdateRecord); // Listen for the Update button too
    
    // Clear form listener
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);

    classFilter.addEventListener('change', loadAndDisplayData); 

    window.onload = loadAndDisplayData;
</script>

</body>
</html>
