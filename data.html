<!DOCTYPE html>
<html>
<head>
    <title>Data Entry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="icon" type="image/png" href="SHIV.png">
    
    <script src="https://raw.githack.com/js-wac/jsPDF-Devanagari-Font/main/NotoSansDevanagari.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* Form and Action Area styles (‡§Ö‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§ø‡§§) */
        .form-fields { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1 1 23%; min-width: 200px; } 
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #photo { padding: 5px; }

        .action-area { display: flex; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .action-area button { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s; 
        }
        
        .action-area button:hover {
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
        }

        #saveBtn, #updateBtn { background-color: #28a745; color: white; } /* Save/Update Button */
        #saveBtn:hover, #updateBtn:hover { background-color: #1e7e34; }
        #clearFormBtn { background-color: #f0ad4e; color: white; } 
        #clearFormBtn:hover { background-color: #ec971f; }
        #printBtn { background-color: #007bff; color: white; }
        #printBtn:hover { background-color: #0056b3; }
        #pdfBtn { background-color: #dc3545; color: white; } 
        #pdfBtn:hover { background-color: #c82333; }
        #excelBtn { background-color: #ffc107; color: #333; } 
        #excelBtn:hover { background-color: #e0a800; }
        #resetBtn { background-color: #6c757d; color: white; } 
        #resetBtn:hover { background-color: #5a6268; }
        
        #printIDCardBtn { background-color: #3f51b5; color: white; }
        #printIDCardBtn:hover { background-color: #303f9f; }
        
        /* Edit Button Style */
        .edit-btn { 
            background-color: #f0ad4e; 
            color: white; 
            padding: 5px 10px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px;
        }
        .edit-btn:hover { background-color: #ec971f; }

        .filter-area { margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        .filter-area label { font-weight: bold; color: #333; }
        .filter-area select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; }


        /* Table Style */
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #007bff; color: white; }
        
        #dataTable th:nth-child(2), #dataTable td:nth-child(2) { width: 4%; text-align: center; } 
        #dataTable th:nth-child(1), #dataTable td:nth-child(1) { width: 4%; text-align: center; } 
        #dataTable th:last-child, #dataTable td:last-child { width: 5%; text-align: center; } /* Edit Column Width */
        
        .photo-column img {
            width: 50px; 
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* --- ID Card Print Area Styles (Previous Optimization) --- */
        .id-card-print-container {
            display: none; 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            padding: 15px; 
            box-sizing: border-box;
        }
        .id-card {
            width: 185px; 
            height: 308px; /* 3 ‡§∞‡•ã ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•á ‡§™‡•á‡§ú ‡§™‡§∞ ‡§´‡§ø‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§ä‡§Å‡§ö‡§æ‡§à */
            border: 1px solid #007bff;
            border-radius: 8px;
            padding: 8px; 
            margin: 5px; 
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            float: left; 
            font-size: 9px; 
            box-sizing: border-box;
            background: #f0f8ff;
            text-align: left; 
        }
        /* ... (rest of the card styles are the same) ... */
        .id-card h3 {
            text-align: center;
            margin: 5px 0 8px 0; 
            color: #007bff;
            border-bottom: 1px dashed #ccc;
            font-size: 13px; 
        }
        .card-photo {
            width: 70px; 
            height: 90px; 
            border: 1px solid #ccc;
            overflow: hidden;
            margin: 0 auto 8px auto; 
        }
        .card-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .card-details-text p {
            margin: 2px 0;
            line-height: 1.1;
            padding-left: 3px; 
        }
        .card-details-text strong {
            display: inline-block;
            width: 60px; 
        }
        .barcode-area {
            text-align: center;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #ddd;
            width: 100%; 
        }
        .barcode-area svg {
            width: 100%; 
            height: 35px;
            display: block; 
        }
        .barcode-id-text {
            font-size: 8px;
            margin: 0;
            font-weight: bold;
            color: #555;
            text-transform: uppercase;
        }

        /* --- Print Styles (4 ‡§ï‡•â‡§≤‡§Æ, 3 ‡§∞‡•ã, ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§Æ‡§æ‡§∞‡•ç‡§ú‡§ø‡§®) --- */
        @media print {
            body > *:not(.id-card-print-container) { 
                display: none !important; 
            }
            
            .id-card-print-container {
                display: grid !important; 
                grid-template-columns: repeat(4, 1fr); 
                grid-auto-rows: 308px;
                gap: 2px;
                position: static;
                padding: 0;
                margin: 0;
                width: 100%;
                height: auto;
                background: white;
            }
            
            @page {
                size: A4 portrait; 
                margin: 0.1cm;
            }

            .id-card {
                width: 100%; 
                height: 100%; 
                margin: 0;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

<div class="container hide-on-print">
    
    <h2>1. ‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§è‡§Ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç / ‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç</h2>
    
    <form id="recordForm">
        <input type="hidden" id="recordId" value=""> 

        <div class="form-fields">
            <div class="form-group"><label for="name">‡§®‡§æ‡§Æ:</label><input type="text" id="name" required></div>
            <div class="form-group"><label for="fatherName">‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</label><input type="text" id="fatherName" required></div>
            <div class="form-group"><label for="motherName">‡§Æ‡§æ‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</label><input type="text" id="motherName" required></div>
            <div class="form-group"><label for="mobile">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞:</label><input type="text" id="mobile" required></div>
            <div class="form-group"><label for="address">‡§™‡§§‡§æ:</label><input type="text" id="address" required></div>
            <div class="form-group"><label for="class">‡§ï‡§ï‡•ç‡§∑‡§æ:</label><input type="text" id="class" required></div>
            <div class="form-group"><label for="pen">PEN:</label><input type="text" id="pen" required></div>
            <div class="form-group"><label for="photo">‡§´‡•ã‡§ü‡•ã ‡§Ö‡§ü‡•à‡§ö ‡§ï‡§∞‡•á‡§Ç (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï):</label><input type="file" id="photo" accept="image/*"></div>
        </div>

        <div class="action-area">
            <button type="submit" id="saveBtn">‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç üíæ</button> 
            <button type="button" id="updateBtn" style="display:none;">‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‚úÖ</button> 
            <button type="button" id="clearFormBtn">‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç üßπ</button> 
        </div>
    </form>

    <hr style="margin: 30px 0;">

    <h2>2. ‡§∏‡•á‡§µ ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•Å‡§Ü ‡§°‡•á‡§ü‡§æ</h2>

    <div class="filter-area">
        <label for="classFilter">‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç:</label>
        <select id="classFilter">
            <option value="all">‡§∏‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§æ‡§∏</option>
        </select>
    </div>

    <div class="action-area">
        <button id="printIDCardBtn">‡§ö‡•Å‡§®‡§æ ‡§π‡•Å‡§Ü ID ‡§ï‡§æ‡§∞‡•ç‡§° ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç ü™™</button>
        <button id="printBtn">‡§™‡•Ç‡§∞‡§æ ‡§ü‡•á‡§¨‡§≤ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç üñ®Ô∏è</button>
        <button id="pdfBtn">PDF ‡•û‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§è‡§Å üìÑ</button>
        <button id="excelBtn">Excel ‡•û‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§è‡§Å (CSV) üìä</button>
        <button id="resetBtn">‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç üóëÔ∏è</button>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
                <th>‡§ï‡•ç‡§∞. ‡§∏‡§Ç.</th> 
                <th>‡§ö‡•Å‡§®‡•á‡§Ç</th>
                <th>‡§´‡•ã‡§ü‡•ã</th>
                <th>‡§®‡§æ‡§Æ</th>
                <th>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
                <th>‡§Æ‡§æ‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
                <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</th>
                <th>‡§™‡§§‡§æ</th>
                <th>‡§ï‡§ï‡•ç‡§∑‡§æ</th>
                <th>PEN</th>
                <th>‡§è‡§ï‡•ç‡§∂‡§®</th> 
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
    <p id="loadingStatus" style="text-align: center; color: #007bff; display: none;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§</p>
</div>

<div class="id-card-print-container" id="idCardPrintContainer">
    </div>

<script>
    const DB_NAME = 'StudentDataDB';
    const STORE_NAME = 'records';
    let db; 
    let editingRecord = null; // To store the ID of the record being edited

    const form = document.getElementById('recordForm');
    const dataTableBody = document.getElementById('dataTable').querySelector('tbody');
    const classFilter = document.getElementById('classFilter');
    const loadingStatus = document.getElementById('loadingStatus');
    const idCardPrintContainer = document.getElementById('idCardPrintContainer');
    const recordIdInput = document.getElementById('recordId');
    const saveBtn = document.getElementById('saveBtn');
    const updateBtn = document.getElementById('updateBtn');

    // --- IndexedDB Setup ---

    function openDB() {
        return new Promise((resolve, reject) => {
            if (db) {
                resolve(db);
                return;
            }
            
            const request = indexedDB.open(DB_NAME, 1);
            request.onerror = (event) => {
                console.error("IndexedDB Error:", event.target.error);
                reject("IndexedDB ‡§ñ‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§");
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            };
        });
    }

    function getStore(mode) {
        return new Promise(async (resolve, reject) => {
            try {
                const dbInstance = await openDB();
                const transaction = dbInstance.transaction(STORE_NAME, mode);
                transaction.onerror = (event) => reject(event.target.error);
                resolve(transaction.objectStore(STORE_NAME));
            } catch (error) {
                reject(error);
            }
        });
    }

    async function getAllRecordsFromDB() {
        try {
            const store = await getStore('readonly');
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.error("Fetch Error:", error);
            return [];
        }
    }
    
    async function getRecordById(id) {
        try {
            const store = await getStore('readonly');
            return new Promise((resolve, reject) => {
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.error("Fetch by ID Error:", error);
            return null;
        }
    }


    // --- ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§î‡§∞ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§π‡•à‡§Ç‡§°‡§≤‡§ø‡§Ç‡§ó ---

    function populateClassFilter(records) {
        const uniqueClasses = [...new Set(records.map(record => record.class))].sort();
        const currentSelection = classFilter.value; 
        
        classFilter.innerHTML = '<option value="all">‡§∏‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§æ‡§∏</option>'; 
        
        uniqueClasses.forEach(className => {
            if (className) {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            }
        });

        classFilter.value = currentSelection;
    }


    async function loadAndDisplayData() {
        loadingStatus.style.display = 'block';
        const allRecords = await getAllRecordsFromDB();
        
        populateClassFilter(allRecords); 
        
        const selectedClass = classFilter.value;

        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        dataTableBody.innerHTML = ''; 

        filteredRecords.forEach((record, index) => {
            const row = dataTableBody.insertRow();
            row.insertCell().textContent = index + 1; 

            const checkboxCell = row.insertCell();
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.classList.add('record-checkbox');
            checkbox.value = record.id; 
            checkboxCell.appendChild(checkbox);
            
            const photoCell = row.insertCell();
            photoCell.classList.add('photo-column');
            if (record.photoBase64) {
                const img = document.createElement('img');
                img.src = record.photoBase64;
                img.alt = "‡§∏‡•ç‡§ü‡•Ç‡§°‡•á‡§Ç‡§ü ‡§´‡•ã‡§ü‡•ã";
                photoCell.appendChild(img);
            } else {
                photoCell.textContent = 'N/A';
            }

            row.insertCell().textContent = record.name;
            row.insertCell().textContent = record.fatherName;
            row.insertCell().textContent = record.motherName;
            row.insertCell().textContent = record.mobile;
            row.insertCell().textContent = record.address;
            row.insertCell().textContent = record.class;
            row.insertCell().textContent = record.pen;
            
            // New Action/Edit Column
            const actionCell = row.insertCell();
            const editButton = document.createElement('button');
            editButton.textContent = '‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç ‚úèÔ∏è';
            editButton.classList.add('edit-btn');
            editButton.dataset.id = record.id;
            editButton.onclick = () => loadRecordForEdit(record.id);
            actionCell.appendChild(editButton);
        });

        loadingStatus.style.display = 'none';
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            if (!file) {
                resolve(null);
                return;
            }
            if (file.size > 2 * 1024 * 1024) {
                alert("‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§´‡•ã‡§ü‡•ã 2MB ‡§∏‡•á ‡§¨‡§°‡§º‡•Ä ‡§π‡•à‡•§ ‡§Ø‡§π IndexedDB ‡§Æ‡•á‡§Ç ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§Ø ‡§≤‡•á ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§");
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    
    function setFormMode(isEditing) {
        if (isEditing) {
            saveBtn.style.display = 'none';
            updateBtn.style.display = 'inline-block';
        } else {
            saveBtn.style.display = 'inline-block';
            updateBtn.style.display = 'none';
            recordIdInput.value = ''; // Clear ID for new record
            editingRecord = null;
        }
    }
    
    async function loadRecordForEdit(id) {
        const record = await getRecordById(id);
        if (record) {
            document.getElementById('name').value = record.name;
            document.getElementById('fatherName').value = record.fatherName;
            document.getElementById('motherName').value = record.motherName;
            document.getElementById('mobile').value = record.mobile;
            document.getElementById('address').value = record.address;
            document.getElementById('class').value = record.class;
            document.getElementById('pen').value = record.pen;
            
            // Store ID and set editing mode
            recordIdInput.value = record.id;
            editingRecord = record; // Store the entire record for comparison (optional)
            setFormMode(true);
            
            // Scroll to the top of the form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            alert("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
        }
    }

    async function saveOrUpdateRecord(event) {
        event.preventDefault(); 
        
        const photoFile = document.getElementById('photo').files[0];
        let photoBase64 = null;
        
        if (photoFile) {
            // New photo uploaded
            photoBase64 = await fileToBase64(photoFile); 
        } else if (editingRecord && editingRecord.photoBase64) {
            // Retain old photo if not uploading new one
            photoBase64 = editingRecord.photoBase64;
        }


        const newRecordData = {
            name: document.getElementById('name').value,
            fatherName: document.getElementById('fatherName').value,
            motherName: document.getElementById('motherName').value,
            mobile: document.getElementById('mobile').value,
            address: document.getElementById('address').value,
            class: document.getElementById('class').value,
            pen: document.getElementById('pen').value,
            photoBase64: photoBase64 
        };
        
        const recordId = recordIdInput.value;
        const isEditing = recordId !== '';

        if (isEditing) {
            // Update an existing record
            newRecordData.id = parseInt(recordId); // ID must be kept for update
            try {
                const store = await getStore('readwrite');
                const request = store.put(newRecordData); // put() updates if ID exists, adds otherwise
                
                request.onsuccess = () => {
                    form.reset();
                    setFormMode(false); // Switch back to save mode
                    loadAndDisplayData();
                    alert("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ! ‚úÖ");
                };

                request.onerror = (event) => {
                    alert(`‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.target.error}`);
                };

            } catch (error) {
                alert(`‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error}`);
            }
            
        } else {
            // Save a new record
            try {
                const store = await getStore('readwrite');
                const request = store.add(newRecordData);
                
                request.onsuccess = () => {
                    form.reset();
                    loadAndDisplayData();
                    alert("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° IndexedDB ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ! üíæ");
                };

                request.onerror = (event) => {
                    alert(`‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.target.error}`);
                };

            } catch (error) {
                alert(`‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error}`);
            }
        }
    }
    
    function clearForm() {
        form.reset();
        setFormMode(false); // Ensure it reverts to Save mode
        alert("‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§´‡§º‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§ï‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§");
    }

    // ***** ‡§Ø‡§π ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ö‡•á‡§ï ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à *****
    function resetData() {
        const password = prompt("‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§°‡§æ‡§≤‡•á‡§Ç:");
        const requiredPassword = '851556'; // ‡§Ü‡§™‡§ï‡§æ ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§ø‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°
        
        if (password === requiredPassword) {
            const confirmReset = confirm("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∏‡§π‡•Ä ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à IndexedDB ‡§∏‡•á ‡§∏‡§≠‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§");
            
            if (confirmReset) {
                try {
                    const request = indexedDB.deleteDatabase(DB_NAME);
                    request.onsuccess = () => {
                        db = null; 
                        loadAndDisplayData(); 
                        alert("‡§∏‡§≠‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§");
                    };
                    request.onerror = (event) => {
                        alert(`‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.target.error}`);
                    };
                } catch(error) {
                     alert(`‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error}`);
                }
            } else {
                alert("‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞ ‡§¶‡•Ä ‡§ó‡§à‡•§");
            }
        } else if (password !== null) {
            alert("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ó‡§≤‡§§ ‡§π‡•à‡•§ ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§");
        } else {
            alert("‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞ ‡§¶‡•Ä ‡§ó‡§à‡•§");
        }
    }
    // *******************************************************
    
    // --- Export/Print Functions (Unchanged) ---
    
    function printTable() {
        window.print(); 
    }

    async function exportPDF() {
        // PDF ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡•â‡§ú‡§ø‡§ï (Unchanged)
        const allRecords = await getAllRecordsFromDB();
        const selectedClass = classFilter.value;
        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        if (filteredRecords.length === 0) {
            alert("PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'pt', 'a4'); 
        doc.setFont('NotoSansDevanagari', 'normal');

        const head = [["‡§ï‡•ç‡§∞. ‡§∏‡§Ç.", "‡§´‡•ã‡§ü‡•ã", "‡§®‡§æ‡§Æ", "‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ", "‡§Æ‡§æ‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ", "‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞", "‡§™‡§§‡§æ", "‡§ï‡§ï‡•ç‡§∑‡§æ", "PEN"]];
        
        const body = filteredRecords.map((record, index) => [
            index + 1, 
            '', 
            record.name,
            record.fatherName,
            record.motherName,
            record.mobile,
            record.address,
            record.class,
            record.pen
        ]);

        doc.autoTable({ 
            head: head,
            body: body,
            startY: 40,
            headStyles: { fillColor: [0, 123, 255], font: 'NotoSansDevanagari', minCellHeight: 20 }, 
            styles: { font: 'NotoSansDevanagari', halign: 'left', fontSize: 8, cellPadding: 3, minCellHeight: 30 },
            columnStyles: {
                0: { cellWidth: 25 }, 
                1: { cellWidth: 35, halign: 'center' } 
            },
            didDrawCell: function(data) {
                if (data.section === 'body' && data.column.index === 1 && filteredRecords[data.row.index].photoBase64) {
                    const photoBase64 = filteredRecords[data.row.index].photoBase64;
                    const margin = 2;
                    doc.addImage(
                        photoBase64, 
                        'JPEG', 
                        data.cell.x + margin, 
                        data.cell.y + margin, 
                        data.cell.width - (margin * 2), 
                        data.cell.height - (margin * 2) 
                    );
                }
            },
            didDrawPage: function(data) {
                doc.setFont('NotoSansDevanagari', 'normal');
                const titleText = selectedClass === 'all' ? 
                                  "‡§∏‡•á‡§µ ‡§ï‡§ø‡§è ‡§ó‡§è ‡§∏‡§≠‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ" : 
                                  `‡§ï‡•ç‡§≤‡§æ‡§∏ ${selectedClass} ‡§ï‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ`;
                doc.text(titleText, 40, 30);
            }
        });
        
        doc.save('Student_Records_PDF.pdf');
    }

    async function exportCSV() {
        // CSV ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§≤‡•â‡§ú‡§ø‡§ï (Unchanged)
        const allRecords = await getAllRecordsFromDB();
        const selectedClass = classFilter.value;
        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        if (filteredRecords.length === 0) {
            alert("‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
            return;
        }

        const headers = ["‡§ï‡•ç‡§∞. ‡§∏‡§Ç.", "‡§®‡§æ‡§Æ", "‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ", "‡§Æ‡§æ‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ", "‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞", "‡§™‡§§‡§æ", "‡§ï‡§ï‡•ç‡§∑‡§æ", "PEN"];
        
        let csv = headers.join(',') + '\n';
        
        filteredRecords.forEach((record, index) => {
            const row = [
                index + 1, 
                record.name,
                record.fatherName,
                record.motherName,
                record.mobile,
                record.address,
                record.class,
                record.pen
            ].map(item => {
                let cleanItem = String(item).replace(/"/g, '""'); 
                return `"${cleanItem}"`; 
            }).join(','); 
            
            csv += row + '\n';
        });

        const BOM = "\uFEFF"; 
        const finalCSV = BOM + csv;
        
        const filename = selectedClass === 'all' ? 
                         'Student_Records_All_Classes.csv' : 
                         `Student_Records_Class_${selectedClass}.csv`;

        const blob = new Blob([finalCSV], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("Excel/CSV ‡•û‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§´‡•ã‡§ü‡•ã ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡•Ä‡•§");
    }


    // --- ID Card Print Function (Unchanged) ---
    
    function generateIDCardHTML(record) {
        const photoSrc = record.photoBase64 || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="#ddd"/><text x="50" y="55" font-size="20" text-anchor="middle" fill="#555">No Photo</text></svg>';

        return `
            <div class="id-card">
                <h3>‡§∂‡•ç‡§∞‡•Ä ‡§¶‡•Å‡§∞‡•ç‡§ó‡•á ‡§Æ‡§æ‡§Å ‡§¨‡§æ‡§≤ ‡§ó‡•ã‡§µ‡§ø‡§®‡•ç‡§¶ ‡§á‡§£‡•ç‡§ü‡§∞ ‡§ï‡§æ‡§≤‡•á‡§ú </h3>
                <div class="card-photo">
                    <img src="${photoSrc}" alt="Student Photo">
                </div>
                <div class="card-details-text">
                    <p><strong>‡§®‡§æ‡§Æ:</strong> ${record.name}</p>
                    <p><strong>‡§ï‡§ï‡•ç‡§∑‡§æ:</strong> ${record.class}</p>
                    <p><strong>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</strong> ${record.fatherName}</p>
                    <p><strong>‡§Æ‡§æ‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</strong> ${record.motherName}</p>
                    <p><strong>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤:</strong> ${record.mobile}</p>
                    <p><strong>PEN:</strong> ${record.pen}</p>
                    <p><strong>‡§™‡§§‡§æ:</strong> ${record.address}</p>
                </div>
                <div class="barcode-area">
                    <svg id="barcode-${record.id}"></svg>
                    <p class="barcode-id-text">ID: ${record.id}</p>
                </div>
            </div>
        `;
    }

    async function printSelectedIDCards() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.record-checkbox:checked'));
        
        if (selectedCheckboxes.length === 0) {
            alert("‡§ï‡•É‡§™‡§Ø‡§æ ID ‡§ï‡§æ‡§∞‡•ç‡§° ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø (Checkbox) ‡§ö‡•Å‡§®‡•á‡§Ç‡•§");
            return;
        }

        const selectedIds = selectedCheckboxes.map(cb => parseInt(cb.value, 10));
        const allRecords = await getAllRecordsFromDB();
        
        const selectedRecords = allRecords.filter(record => selectedIds.includes(record.id));

        if (selectedRecords.length === 0) {
            alert("‡§ö‡•Å‡§®‡•á ‡§ó‡§è ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
            return;
        }

        // 1. HTML ‡§ú‡•á‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ DOM ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
        idCardPrintContainer.innerHTML = '';
        selectedRecords.forEach(record => {
            idCardPrintContainer.innerHTML += generateIDCardHTML(record);
        });

        // 2. DOM ‡§Æ‡•á‡§Ç HTML ‡§ú‡•Å‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶, ‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§ú‡•á‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§ï‡•á‡§µ‡§≤ ID ‡§ï‡•ã ‡§è‡§®‡•ç‡§ï‡•ã‡§° ‡§ï‡§∞‡§§‡§æ ‡§π‡•à)
        selectedRecords.forEach(record => {
            const barcodeElement = document.getElementById(`barcode-${record.id}`);
            if (barcodeElement) {
                JsBarcode(barcodeElement, String(record.id), {
                    format: "CODE128", 
                    displayValue: false, 
                    margin: 0,
                    width: 1.5, // ‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§ï‡•Ä ‡§ö‡•å‡§°‡§º‡§æ‡§à
                    height: 35, // ‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§ï‡•Ä ‡§ä‡§Å‡§ö‡§æ‡§à
                    background: "#f0f8ff"
                });
            }
        });

        // 3. ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§
        window.print();
        
        // 4. ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç
        setTimeout(() => {
            idCardPrintContainer.innerHTML = '';
        }, 500); 
    }


    // --- ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞ ---
    document.getElementById('printIDCardBtn').addEventListener('click', printSelectedIDCards); 
    document.getElementById('printBtn').addEventListener('click', printTable);
    document.getElementById('pdfBtn').addEventListener('click', exportPDF);
    document.getElementById('excelBtn').addEventListener('click', exportCSV);
    document.getElementById('resetBtn').addEventListener('click', resetData);
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);
    
    // Use a unified function for Save/Update
    form.addEventListener('submit', saveOrUpdateRecord); 
    updateBtn.addEventListener('click', saveOrUpdateRecord); // Listen for the Update button too
    
    // Clear form listener
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);

    classFilter.addEventListener('change', loadAndDisplayData); 

    window.onload = loadAndDisplayData;
</script>

</body>
</html>
