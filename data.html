<!DOCTYPE html>
<html>
<head>
    <title>Data Entry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <link rel="icon" type="image/png" href="logo.png">
    
    <script src="https://raw.githack.com/js-wac/jsPDF-Devanagari-Font/main/NotoSansDevanagari.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* Form and Action Area styles (‡§Ö‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§ø‡§§) */
        .form-fields { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1 1 23%; min-width: 200px; } 
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #photo { padding: 5px; }

        .action-area { display: flex; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .action-area button { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s; 
        }
        
        .action-area button:hover {
            transform: translateY(-9px); 
            box-shadow: 0 4px 8px rgba(102, 110, 120, 0.2); 
        }

        #saveBtn, #updateBtn { background-color: #28a745; color: white; } /* Save/Update Button */
        #saveBtn:hover, #updateBtn:hover { background-color: #1e7e34; }
        #clearFormBtn { background-color: #f0ad4e; color: white; } 
        #clearFormBtn:hover { background-color: #ec971f; }
        #printBtn { background-color: #007bff; color: white; }
        #printBtn:hover { background-color: #0056b3; }
        #pdfBtn { background-color: #dc3545; color: white; } 
        #pdfBtn:hover { background-color: #c82333; }
        #excelBtn { background-color: #ffc107; color: #333; } 
        #excelBtn:hover { background-color: #e0a800; }
        #resetBtn { background-color: #6c757d; color: white; } 
        #resetBtn:hover { background-color: #5a6268; }
        
        /* NEW STYLES for Import/Export/WhatsApp */
        #whatsappBtn { background-color: #25D366; color: white; } 
        #whatsappBtn:hover { background-color: #128C7E; }

        #jsonBtn { background-color: #8A2BE2; color: white; } /* JSON Export */
        #jsonBtn:hover { background-color: #6A1BAA; }
        
        #importJsonBtn { background-color: #008080; color: white; } /* JSON Import */
        #importJsonBtn:hover { background-color: #006666; }
        /* -------------------------------- */

        #printIDCardBtn { background-color: #3f51b5; color: white; }
        #printIDCardBtn:hover { background-color: #303f9f; }
        
        /* Edit Button Style */
        .edit-btn { 
            background-color: #f0ad4e; 
            color: white; 
            padding: 5px 10px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px;
        }
        .edit-btn:hover { background-color: #ec971f; }

        .filter-area { margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        .filter-area label { font-weight: bold; color: #333; }
        .filter-area select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; }


        /* Table Style */
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #007bff; color: white; }
        
        #dataTable th:nth-child(2), #dataTable td:nth-child(2) { width: 4%; text-align: center; } 
        #dataTable th:nth-child(1), #dataTable td:nth-child(1) { width: 4%; text-align: center; } 
        #dataTable th:last-child, #dataTable td:last-child { width: 5%; text-align: center; } /* Edit Column Width */
        
        .photo-column img {
            width: 50px; 
            height: 50px;
            object-fit: cover;
            border-radius: 29px;
        }

        /* --- ID Card Print Area Styles --- */
        .id-card-print-container {
            display: none; 
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            padding: 15px; 
            box-sizing: border-box;
        }
        .id-card {
            width: 185px; 
            height: 308px; 
            border: 1px solid #007bff;
            border-radius: 8px;
            padding: 8px; 
            margin: 5px; 
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            float: left; 
            font-size: 9px; 
            box-sizing: border-box;
            background: #f0f8ff;
            text-align: left; 
        }
        .id-card h3 {
            text-align: center;
            margin: 5px 0 8px 0; 
            color: #007bff;
            border-bottom: 1px dashed #ccc;
            font-size: 13px; 
        }
        .card-photo {
            width: 70px; 
            height: 90px; 
            border: 1px solid #ccc;
            overflow: hidden;
            margin: 0 auto 8px auto; 
        }
        .card-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .card-details-text p {
            margin: 2px 0;
            line-height: 1.1;
            padding-left: 3px; 
        }
        .card-details-text strong {
            display: inline-block;
            width: 60px; 
        }
        /* ‡§¨‡§æ‡§∞‡§ï‡•ã‡§° ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à */

        /* --- Print Styles (Conditional Visibility) --- */
        @media print {
            /* 1. Print ID Card Mode */
            body.id-card-mode .container {
                display: none !important;
            }
            body.id-card-mode .id-card-print-container {
                display: grid !important; 
                grid-template-columns: repeat(4, 1fr); 
                grid-auto-rows: 308px;
                gap: 2px;
                position: static;
                padding: 0;
                margin: 0;
                width: 100%;
                height: auto;
                background: white;
            }
            body.id-card-mode .id-card {
                width: 100%; 
                height: 100%; 
                margin: 0;
                page-break-inside: avoid;
            }

            /* 2. Print Table Mode */
            body.table-mode .id-card-print-container {
                display: none !important;
            }
            body.table-mode .container {
                max-width: none !important; 
                box-shadow: none !important;
                padding: 0 !important;
                display: block !important;
            }
            body.table-mode h2, body.table-mode .form-fields, body.table-mode .action-area, body.table-mode .filter-area {
                display: none !important; 
            }
            body.table-mode table {
                margin-top: 0 !important;
            }

            @page {
                size: A4 portrait; 
                margin: 0.5cm;
            }
        }
    </style>
</head>
<body>

<div class="container"> 
    
    <h2>0. ‡§∏‡•ç‡§ï‡•Ç‡§≤/‡§ï‡•â‡§≤‡•á‡§ú ‡§≤‡•ã‡§ó‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (ID ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡•á ‡§≤‡§ø‡§è)</h2>
    <div class="form-fields">
        <div class="form-group" style="flex: 1 1 45%; min-width: 300px;">
            <label for="logoUpload">‡§≤‡•ã‡§ó‡•ã ‡§á‡§Æ‡•á‡§ú (PNG/JPG):</label>
            <input type="file" id="logoUpload" accept="image/*">
        </div>
        <div class="form-group" style="flex: 1 1 45%; min-width: 300px;">
            <label>‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§≤‡•ã‡§ó‡•ã:</label>
            <div id="currentLogoDisplay" style="width: 50px; height: 50px; border: 1px dashed #ccc; padding: 5px; text-align: center;">
                ‡§ï‡•ã‡§à ‡§≤‡•ã‡§ó‡•ã ‡§®‡§π‡•Ä‡§Ç
            </div>
            <button type="button" id="removeLogoBtn" style="background-color: #dc3545; color: white; margin-top: 5px; padding: 5px 10px; border-radius: 4px; display: none;">‡§≤‡•ã‡§ó‡•ã ‡§π‡§ü‡§æ‡§è‡§Å üóëÔ∏è</button>
        </div>
    </div>
    
    <hr style="margin: 30px 0;">
    <h2>1. ‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§è‡§Ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç / ‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç</h2>
    
    <form id="recordForm">
        <input type="hidden" id="recordId" value=""> 

        <div class="form-fields">
            <div class="form-group"><label for="name">‡§®‡§æ‡§Æ:</label><input type="text" id="name" required></div>
            <div class="form-group"><label for="fatherName">‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</label><input type="text" id="fatherName" required></div>
            <div class="form-group"><label for="motherName">‡§Æ‡§æ‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</label><input type="text" id="motherName" required></div>
            <div class="form-group"><label for="mobile">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞:</label><input type="text" id="mobile" required></div>
            <div class="form-group"><label for="address">‡§™‡§§‡§æ:</label><input type="text" id="address" required></div>
            <div class="form-group"><label for="class">‡§ï‡§ï‡•ç‡§∑‡§æ:</label><input type="text" id="class" required></div>
            <div class="form-group"><label for="pen">PEN:</label><input type="text" id="pen" required></div>
            <div class="form-group"><label for="photo">‡§´‡•ã‡§ü‡•ã ‡§Ö‡§ü‡•à‡§ö ‡§ï‡§∞‡•á‡§Ç (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï):</label><input type="file" id="photo" accept="image/*"></div>
        </div>

        <div class="action-area">
            <button type="submit" id="saveBtn">‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç üíæ</button> 
            <button type="button" id="updateBtn" style="display:none;">‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‚úÖ</button> 
            <button type="button" id="clearFormBtn">‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç üßπ</button> 
        </div>
    </form>
    
    <input type="file" id="importFile" accept=".json" style="display: none;">

    <hr style="margin: 30px 0;">

    <h2>2. ‡§∏‡•á‡§µ ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•Å‡§Ü ‡§°‡•á‡§ü‡§æ</h2>

    <div class="filter-area">
        <label for="classFilter">‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç:</label>
        <select id="classFilter">
            <option value="all">‡§∏‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§æ‡§∏</option>
        </select>
    </div>

    <div class="action-area">
        <button id="printIDCardBtn">‡§ö‡•Å‡§®‡§æ ‡§π‡•Å‡§Ü ID ‡§ï‡§æ‡§∞‡•ç‡§° ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç ü™™</button>
        <button id="printBtn">‡§™‡•Ç‡§∞‡§æ ‡§ü‡•á‡§¨‡§≤ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç üñ®Ô∏è</button>
        <button id="pdfBtn">PDF ‡•û‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§è‡§Å üìÑ</button>
        <button id="excelBtn">Excel ‡•û‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§è‡§Å (CSV) üìä</button>
        
        <button id="importJsonBtn">‡§°‡•á‡§ü‡§æ ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç üì•</button>
        <button id="jsonBtn">JSON ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç üì§</button>
        <button id="whatsappBtn">‡§°‡•á‡§ü‡§æ WhatsApp ‡§ï‡§∞‡•á‡§Ç üì±</button> 

        <button id="resetBtn">‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç üóëÔ∏è</button>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
                <th>‡§ï‡•ç‡§∞. ‡§∏‡§Ç.</th> 
                <th>‡§ö‡•Å‡§®‡•á‡§Ç</th>
                <th>‡§´‡•ã‡§ü‡•ã</th>
                <th>‡§®‡§æ‡§Æ</th>
                <th>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
                <th>‡§Æ‡§æ‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
                <th>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</th>
                <th>‡§™‡§§‡§æ</th>
                <th>‡§ï‡§ï‡•ç‡§∑‡§æ</th>
                <th>PEN</th>
                <th>‡§è‡§ï‡•ç‡§∂‡§®</th> 
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
    <p id="loadingStatus" style="text-align: center; color: #007bff; display: none;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§</p>
</div>

<div class="id-card-print-container" id="idCardPrintContainer">
    </div>

<script>
    const DB_NAME = 'StudentDataDB';
    const STORE_NAME = 'records';
    const LOGO_STORAGE_KEY = 'schoolLogoBase64'; // NEW: Logo storage key
    
    let db; 
    let editingRecord = null; 

    // **‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è Base64 ‡§Æ‡•á‡§Ç ‡§è‡§®‡•ç‡§ï‡•ã‡§° ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°: 851556**
    const ENCRYPTED_PASSWORD = 'ODUxNTU2'; 
    // **********************************************

    const form = document.getElementById('recordForm');
    const dataTableBody = document.getElementById('dataTable').querySelector('tbody');
    const classFilter = document.getElementById('classFilter');
    const loadingStatus = document.getElementById('loadingStatus');
    const idCardPrintContainer = document.getElementById('idCardPrintContainer');
    const recordIdInput = document.getElementById('recordId');
    const saveBtn = document.getElementById('saveBtn');
    const updateBtn = document.getElementById('updateBtn');
    const importFileElement = document.getElementById('importFile');
    
    // NEW: Logo elements
    const logoUploadInput = document.getElementById('logoUpload');
    const currentLogoDisplay = document.getElementById('currentLogoDisplay');
    const removeLogoBtn = document.getElementById('removeLogoBtn');


    // --- IndexedDB Setup (Unchanged) ---
    function openDB() {
        return new Promise((resolve, reject) => {
            if (db) {
                resolve(db);
                return;
            }
            
            const request = indexedDB.open(DB_NAME, 1);
            request.onerror = (event) => {
                console.error("IndexedDB Error:", event.target.error);
                reject("IndexedDB ‡§ñ‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§");
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            };
        });
    }

    function getStore(mode) {
        return new Promise(async (resolve, reject) => {
            try {
                const dbInstance = await openDB();
                const transaction = dbInstance.transaction(STORE_NAME, mode);
                transaction.onerror = (event) => reject(event.target.error);
                resolve(transaction.objectStore(STORE_NAME));
            } catch (error) {
                reject(error);
            }
        });
    }

    async function getAllRecordsFromDB() {
        try {
            const store = await getStore('readonly');
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.error("Fetch Error:", error);
            return [];
        }
    }
    
    async function getRecordById(id) {
        try {
            const store = await getStore('readonly');
            return new Promise((resolve, reject) => {
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        } catch (error) {
            console.error("Fetch by ID Error:", error);
            return null;
        }
    }

    // --- ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§î‡§∞ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§π‡•à‡§Ç‡§°‡§≤‡§ø‡§Ç‡§ó (Unchanged) ---

    function populateClassFilter(records) {
        const uniqueClasses = [...new Set(records.map(record => record.class))].sort();
        const currentSelection = classFilter.value; 
        
        classFilter.innerHTML = '<option value="all">‡§∏‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§æ‡§∏</option>'; 
        
        uniqueClasses.forEach(className => {
            if (className) {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            }
        });

        classFilter.value = currentSelection;
    }


    async function loadAndDisplayData() {
        loadingStatus.style.display = 'block';
        const allRecords = await getAllRecordsFromDB();
        
        populateClassFilter(allRecords); 
        
        const selectedClass = classFilter.value;

        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        dataTableBody.innerHTML = ''; 

        filteredRecords.forEach((record, index) => {
            const row = dataTableBody.insertRow();
            row.insertCell().textContent = index + 1; 

            const checkboxCell = row.insertCell();
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.classList.add('record-checkbox');
            checkbox.value = record.id; 
            checkboxCell.appendChild(checkbox);
            
            const photoCell = row.insertCell();
            photoCell.classList.add('photo-column');
            if (record.photoBase64) {
                const img = document.createElement('img');
                img.src = record.photoBase64;
                img.alt = "‡§∏‡•ç‡§ü‡•Ç‡§°‡•á‡§Ç‡§ü ‡§´‡•ã‡§ü‡•ã";
                photoCell.appendChild(img);
            } else {
                photoCell.textContent = 'N/A';
            }

            row.insertCell().textContent = record.name;
            row.insertCell().textContent = record.fatherName;
            row.insertCell().textContent = record.motherName;
            row.insertCell().textContent = record.mobile;
            row.insertCell().textContent = record.address;
            row.insertCell().textContent = record.class;
            row.insertCell().textContent = record.pen;
            
            // New Action/Edit Column
            const actionCell = row.insertCell();
            const editButton = document.createElement('button');
            editButton.textContent = '‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç ‚úèÔ∏è';
            editButton.classList.add('edit-btn');
            editButton.dataset.id = record.id;
            editButton.onclick = () => loadRecordForEdit(record.id);
            actionCell.appendChild(editButton);
        });

        loadingStatus.style.display = 'none';
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            if (!file) {
                resolve(null);
                return;
            }
            if (file.size > 2 * 1024 * 1024) {
                alert("‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§´‡•ã‡§ü‡•ã 2MB ‡§∏‡•á ‡§¨‡§°‡§º‡•Ä ‡§π‡•à‡•§ ‡§Ø‡§π IndexedDB ‡§Æ‡•á‡§Ç ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§Ø ‡§≤‡•á ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§");
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    
    function setFormMode(isEditing) {
        if (isEditing) {
            saveBtn.style.display = 'none';
            updateBtn.style.display = 'inline-block';
        } else {
            saveBtn.style.display = 'inline-block';
            updateBtn.style.display = 'none';
            recordIdInput.value = ''; // Clear ID for new record
            editingRecord = null;
        }
    }
    
    // ***** PASSWORD CHECK FUNCTIONS (Unchanged) *****
    async function loadRecordForEdit(id) {
        // --- 1. ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ú‡§æ‡§Å‡§ö ---
        const password = prompt("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§è‡§°‡§ø‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§°‡§æ‡§≤‡•á‡§Ç:");
        const requiredPassword = atob(ENCRYPTED_PASSWORD); 
        
        if (password !== requiredPassword) {
            if (password !== null) {
                alert("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ó‡§≤‡§§ ‡§π‡•à‡•§ ‡§Ü‡§™ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§è‡§°‡§ø‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á‡•§");
            }
            return; 
        }
        // -------------------------

        const record = await getRecordById(id);
        if (record) {
            document.getElementById('name').value = record.name;
            document.getElementById('fatherName').value = record.fatherName;
            document.getElementById('motherName').value = record.motherName;
            document.getElementById('mobile').value = record.mobile;
            document.getElementById('address').value = record.address;
            document.getElementById('class').value = record.class;
            document.getElementById('pen').value = record.pen;
            
            // Store ID and set editing mode
            recordIdInput.value = record.id;
            editingRecord = record; 
            setFormMode(true);
            
            // Scroll to the top of the form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            alert("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
        }
    }
    
    async function saveOrUpdateRecord(event) {
        event.preventDefault(); 
        
        const photoFile = document.getElementById('photo').files[0];
        let photoBase64 = null;
        
        if (photoFile) {
            photoBase64 = await fileToBase64(photoFile); 
        } else if (editingRecord && editingRecord.photoBase64) {
            photoBase64 = editingRecord.photoBase64;
        }


        const newRecordData = {
            name: document.getElementById('name').value,
            fatherName: document.getElementById('fatherName').value,
            motherName: document.getElementById('motherName').value,
            mobile: document.getElementById('mobile').value,
            address: document.getElementById('address').value,
            class: document.getElementById('class').value,
            pen: document.getElementById('pen').value,
            photoBase64: photoBase64 
        };
        
        const recordId = recordIdInput.value;
        const isEditing = recordId !== '';

        if (isEditing) {
            newRecordData.id = parseInt(recordId); 
            try {
                const store = await getStore('readwrite');
                const request = store.put(newRecordData); 
                
                request.onsuccess = () => {
                    form.reset();
                    setFormMode(false); 
                    loadAndDisplayData();
                    alert("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ! ‚úÖ");
                };

                request.onerror = (event) => {
                    alert(`‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.target.error}`);
                };

            } catch (error) {
                alert(`‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error}`);
            }
            
        } else {
            try {
                const store = await getStore('readwrite');
                const request = store.add(newRecordData);
                
                request.onsuccess = () => {
                    form.reset();
                    loadAndDisplayData();
                    alert("‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° IndexedDB ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ! üíæ");
                };

                request.onerror = (event) => {
                    alert(`‡§°‡•á‡§ü‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.target.error}`);
                };

            } catch (error) {
                alert(`‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error}`);
            }
        }
    }
    
    function clearForm() {
        form.reset();
        setFormMode(false); 
        alert("‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§´‡§º‡•Ä‡§≤‡•ç‡§°‡•ç‡§∏ ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§ï‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§");
    }

    function resetData() {
        const password = prompt("‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§°‡§æ‡§≤‡•á‡§Ç:");
        
        const requiredPassword = atob(ENCRYPTED_PASSWORD); 
        
        if (password === requiredPassword) {
            const confirmReset = confirm("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∏‡§π‡•Ä ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à IndexedDB ‡§∏‡•á ‡§∏‡§≠‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§");
            
            if (confirmReset) {
                try {
                    const request = indexedDB.deleteDatabase(DB_NAME);
                    request.onsuccess = () => {
                        db = null; 
                        loadAndDisplayData(); 
                        alert("‡§∏‡§≠‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§");
                    };
                    request.onerror = (event) => {
                        alert(`‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.target.error}`);
                    };
                } catch(error) {
                     alert(`‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error}`);
                }
            } else {
                alert("‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞ ‡§¶‡•Ä ‡§ó‡§à‡•§");
            }
        } else if (password !== null) {
            alert("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ó‡§≤‡§§ ‡§π‡•à‡•§ ‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§");
        } else {
            alert("‡§°‡•á‡§ü‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞ ‡§¶‡•Ä ‡§ó‡§à‡•§");
        }
    }
    // *******************************************************
    
    // --- NEW LOGO FUNCTIONS ---

    function handleLogoUpload(event) {
        const file = event.target.files[0];
        if (file) {
            if (!file.type.startsWith('image/')) {
                alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§á‡§Æ‡•á‡§ú ‡•û‡§æ‡§á‡§≤ (PNG, JPG) ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§");
                return;
            }
            if (file.size > 500 * 1024) { // 500KB limit for logo
                alert("‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§≤‡•ã‡§ó‡•ã ‡•û‡§æ‡§á‡§≤ 500KB ‡§∏‡•á ‡§¨‡•ú‡•Ä ‡§π‡•à‡•§ ‡§Ø‡§π ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§Ø ‡§≤‡•á ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§");
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Logo = e.target.result;
                localStorage.setItem(LOGO_STORAGE_KEY, base64Logo); // Save to localStorage
                displayCurrentLogo();
                alert("‡§≤‡•ã‡§ó‡•ã ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à! ‚úÖ");
            };
            reader.onerror = () => alert("‡§≤‡•ã‡§ó‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§");
            reader.readAsDataURL(file);
        }
    }

    function displayCurrentLogo() {
        const storedLogo = localStorage.getItem(LOGO_STORAGE_KEY);
        currentLogoDisplay.innerHTML = ''; // Clear existing content

        if (storedLogo) {
            const img = document.createElement('img');
            img.src = storedLogo;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            currentLogoDisplay.appendChild(img);
            removeLogoBtn.style.display = 'inline-block';
        } else {
            currentLogoDisplay.textContent = '‡§ï‡•ã‡§à ‡§≤‡•ã‡§ó‡•ã ‡§®‡§π‡•Ä‡§Ç';
            removeLogoBtn.style.display = 'none';
        }
    }

    function removeLogo() {
        if (confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∏‡•á‡§µ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§≤‡•ã‡§ó‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) {
            localStorage.removeItem(LOGO_STORAGE_KEY);
            displayCurrentLogo();
            alert("‡§≤‡•ã‡§ó‡•ã ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§");
        }
    }
    
    // --- Export/Print Functions (UPDATED) ---

    function printTable() {
        // 1. body ‡§™‡§∞ 'table-mode' ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
        document.body.classList.add('table-mode');
        document.body.classList.remove('id-card-mode'); // Ensure card mode is off
        
        // 2. ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§∞‡•á‡§Ç
        window.print(); 
        
        // 3. ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ñ‡§§‡•ç‡§Æ ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç
        setTimeout(() => {
            document.body.classList.remove('table-mode');
        }, 500);
    }


    async function exportPDF() {
        const allRecords = await getAllRecordsFromDB();
        const selectedClass = classFilter.value;
        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        if (filteredRecords.length === 0) {
            alert("PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'pt', 'a4'); 
        doc.setFont('NotoSansDevanagari', 'normal');

        const head = [["‡§ï‡•ç‡§∞. ‡§∏‡§Ç.", "‡§´‡•ã‡§ü‡•ã", "‡§®‡§æ‡§Æ", "‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ", "‡§Æ‡§æ‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ", "‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞", "‡§™‡§§‡§æ", "‡§ï‡§ï‡•ç‡§∑‡§æ", "PEN"]];
        
        const body = filteredRecords.map((record, index) => [
            index + 1, 
            '', 
            record.name,
            record.fatherName,
            record.motherName,
            record.mobile,
            record.address,
            record.class,
            record.pen
        ]);

        doc.autoTable({ 
            head: head,
            body: body,
            startY: 40,
            headStyles: { fillColor: [0, 123, 255], font: 'NotoSansDevanagari', minCellHeight: 20 }, 
            styles: { font: 'NotoSansDevanagari', halign: 'left', fontSize: 8, cellPadding: 3, minCellHeight: 30 },
            columnStyles: {
                0: { cellWidth: 25 }, 
                1: { cellWidth: 35, halign: 'center' } 
            },
            didDrawCell: function(data) {
                if (data.section === 'body' && data.column.index === 1 && filteredRecords[data.row.index].photoBase64) {
                    const photoBase64 = filteredRecords[data.row.index].photoBase64;
                    const margin = 2;
                    doc.addImage(
                        photoBase64, 
                        'JPEG', 
                        data.cell.x + margin, 
                        data.cell.y + margin, 
                        data.cell.width - (margin * 2), 
                        data.cell.height - (margin * 2) 
                    );
                }
            },
            didDrawPage: function(data) {
                doc.setFont('NotoSansDevanagari', 'normal');
                const titleText = selectedClass === 'all' ? 
                                  "‡§∏‡•á‡§µ ‡§ï‡§ø‡§è ‡§ó‡§è ‡§∏‡§≠‡•Ä ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ" : 
                                  `‡§ï‡•ç‡§≤‡§æ‡§∏ ${selectedClass} ‡§ï‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ`;
                doc.text(titleText, 40, 30);
            }
        });
        
        doc.save('Student_Records_PDF.pdf');
    }

    async function exportCSV() {
        const allRecords = await getAllRecordsFromDB();
        const selectedClass = classFilter.value;
        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        if (filteredRecords.length === 0) {
            alert("‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
            return;
        }

        const headers = ["‡§ï‡•ç‡§∞. ‡§∏‡§Ç.", "‡§®‡§æ‡§Æ", "‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ", "‡§Æ‡§æ‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ", "‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞", "‡§™‡§§‡§æ", "‡§ï‡§ï‡•ç‡§∑‡§æ", "PEN"];
        
        let csv = headers.join(',') + '\n';
        
        filteredRecords.forEach((record, index) => {
            const row = [
                index + 1, 
                record.name,
                record.fatherName,
                record.motherName,
                record.mobile,
                record.address,
                record.class,
                record.pen
            ].map(item => {
                let cleanItem = String(item).replace(/"/g, '""'); 
                return `"${cleanItem}"`; 
            }).join(','); 
            
            csv += row + '\n';
        });

        const BOM = "\uFEFF"; 
        const finalCSV = BOM + csv;
        
        const filename = selectedClass === 'all' ? 
                         'Student_Records_All_Classes.csv' : 
                         `Student_Records_Class_${selectedClass}.csv`;

        const blob = new Blob([finalCSV], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("Excel/CSV ‡•û‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§´‡•ã‡§ü‡•ã ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡•Ä‡•§");
    }

    async function exportJSON() {
        const allRecords = await getAllRecordsFromDB();
        const selectedClass = classFilter.value;
        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        if (filteredRecords.length === 0) {
            alert("‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
            return;
        }

        const cleanRecords = filteredRecords.map(record => {
            const { photoBase64, ...rest } = record;
            return rest;
        });
        
        const jsonString = JSON.stringify(cleanRecords, null, 2); 
        
        const filename = selectedClass === 'all' ? 
                         'Student_Records_All_Classes_Backup.json' : 
                         `Student_Records_Class_${selectedClass}_Backup.json`;

        const blob = new Blob([jsonString], { type: 'application/json' });
        const link = document.createElement("a");
        
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("JSON ‡§¨‡•à‡§ï‡§Ö‡§™ ‡•û‡§æ‡§á‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§");
    }

    async function importDataFromJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        // --- 1. ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ú‡§æ‡§Å‡§ö ---
        const password = prompt("‡§°‡•á‡§ü‡§æ ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§°‡§æ‡§≤‡•á‡§Ç:");
        const requiredPassword = atob(ENCRYPTED_PASSWORD); 
        
        if (password !== requiredPassword) {
            alert("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ó‡§≤‡§§ ‡§π‡•à‡•§ ‡§Ü‡§™ ‡§°‡•á‡§ü‡§æ ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á‡•§");
            importFileElement.value = ''; 
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const jsonContent = JSON.parse(e.target.result);
                if (!Array.isArray(jsonContent)) {
                    alert("JSON ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§´‡§º‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§ó‡§≤‡§§ ‡§π‡•à‡•§ ‡§Ø‡§π ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡•Ä ‡§è‡§ï Array ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è‡•§");
                    return;
                }
                
                const store = await getStore('readwrite');
                let importedCount = 0;
                let errorCount = 0;

                for (const record of jsonContent) {
                    const { id, ...newRecord } = record; 
                    
                    try {
                        await new Promise((resolve, reject) => {
                            const request = store.add(newRecord);
                            request.onsuccess = () => {
                                importedCount++;
                                resolve();
                            };
                            request.onerror = (event) => {
                                console.error("Import Error for record:", newRecord, event.target.error);
                                errorCount++;
                                resolve(); 
                            };
                        });
                    } catch (err) {
                        errorCount++;
                    }
                }
                
                await store.transaction.oncomplete; 

                loadAndDisplayData();
                alert(`‡§°‡•á‡§ü‡§æ ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§´‡§≤! ‚úÖ\n‡§ï‡•Å‡§≤ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è: ${importedCount}\n‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡§Ø‡§æ‡§Å: ${errorCount}`);
                
            } catch (error) {
                alert(`JSON ‡•û‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§™‡§¢‡§º‡§®‡•á/‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`);
            } finally {
                importFileElement.value = ''; 
            }
        };
        reader.readAsText(file);
    }
    
    async function sendWhatsAppMessage() {
        const selectedClass = classFilter.value;
        const allRecords = await getAllRecordsFromDB();
        
        const filteredRecords = allRecords.filter(record => 
            selectedClass === 'all' || record.class === selectedClass
        );

        let classInfo = selectedClass === 'all' ? "‡§∏‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§æ‡§∏‡•ã‡§Ç" : `‡§ï‡•ç‡§≤‡§æ‡§∏ ${selectedClass}`;
        
        const message = encodeURIComponent(
            `‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§Ø‡§π‡§æ‡§Å ${classInfo} ‡§ï‡•á ${filteredRecords.length} ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§ü‡•à‡§ö ‡§ï‡•Ä ‡§ó‡§à PDF ‡§Ø‡§æ JSON ‡•û‡§æ‡§á‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§`
        );
        
        const phoneNumber = "8090155304"; 

        window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
        
        alert("‡§è‡§ï ‡§®‡§à ‡§ü‡•à‡§¨ ‡§Æ‡•á‡§Ç WhatsApp ‡§ö‡•à‡§ü ‡§ñ‡•Å‡§≤ ‡§ó‡§à ‡§π‡•à‡•§\n\n**‡§Ø‡§æ‡§¶ ‡§∞‡§ñ‡•á‡§Ç:** ‡§Ü‡§™‡§ï‡•ã PDF/JSON ‡•û‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§Ö‡§ü‡•à‡§ö ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§");
    }

    // --- ID Card Print Function (FIXED to use uploaded Base64 logo) ---
    
    function generateIDCardHTML(record) {
        const photoSrc = record.photoBase64 || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="#ddd"/><text x="50" y="55" font-size="20" text-anchor="middle" fill="#555">No Photo</text></svg>';

        // NEW: Get the stored logo. Fallback to 'logo.png' if not stored.
        const logoSrc = localStorage.getItem(LOGO_STORAGE_KEY) || 'logo.png'; 

        return `
            <div class="id-card">
                <div style="text-align: center; margin-bottom: 1px; padding-top: 1px;">
                    <img src="${logoSrc}" alt="School Logo" style="width: 40px; height: 40px; object-fit: contain;">
                    </div>
                
                <h3>‡§∂‡•ç‡§∞‡•Ä ‡§¶‡•Å‡§∞‡•ç‡§ó‡•á ‡§Æ‡§æ‡§Å ‡§¨‡§æ‡§≤ ‡§ó‡•ã‡§µ‡§ø‡§®‡•ç‡§¶ ‡§á‡§£‡•ç‡§ü‡§∞ ‡§ï‡§æ‡§≤‡•á‡§ú</h3>
                
                <div class="card-photo">
                    <img src="${photoSrc}" alt="Student Photo">
                </div>
                
                <div class="card-details-text">
                    <p><strong>‡§®‡§æ‡§Æ:</strong> ${record.name}</p>
                    <p><strong>‡§ï‡§ï‡•ç‡§∑‡§æ:</strong> ${record.class}</p>
                    <p><strong>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</strong> ${record.fatherName}</p>
                    <p><strong>‡§Æ‡§æ‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</strong> ${record.motherName}</p>
                    <p><strong>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤:</strong> ${record.mobile}</p>
                    <p><strong>PEN:</strong> ${record.pen}</p>
                    <p style="margin-top: 8px;"><strong>‡§™‡§§‡§æ:</strong> ${record.address}</p>
                </div>
            </div>
        `;
    }

    async function printSelectedIDCards() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.record-checkbox:checked'));
        
        if (selectedCheckboxes.length === 0) {
            alert("‡§ï‡•É‡§™‡§Ø‡§æ ID ‡§ï‡§æ‡§∞‡•ç‡§° ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø (Checkbox) ‡§ö‡•Å‡§®‡•á‡§Ç‡•§");
            return;
        }

        const selectedIds = selectedCheckboxes.map(cb => parseInt(cb.value, 10));
        const allRecords = await getAllRecordsFromDB();
        
        const selectedRecords = allRecords.filter(record => selectedIds.includes(record.id));

        if (selectedRecords.length === 0) {
            alert("‡§ö‡•Å‡§®‡•á ‡§ó‡§è ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
            return;
        }

        // 1. HTML ‡§ú‡•á‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ DOM ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
        idCardPrintContainer.innerHTML = '';
        selectedRecords.forEach(record => {
            idCardPrintContainer.innerHTML += generateIDCardHTML(record);
        });

        // 2. body ‡§™‡§∞ 'id-card-mode' ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
        document.body.classList.add('id-card-mode');
        document.body.classList.remove('table-mode'); // Ensure table mode is off

        // 3. ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§∞‡•á‡§Ç
        window.print();
        
        // 4. ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§π‡§ü‡§æ‡§è‡§Å
        setTimeout(() => {
            idCardPrintContainer.innerHTML = '';
            document.body.classList.remove('id-card-mode');
        }, 500); 
    }

    // --- ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞ ---
    document.getElementById('printIDCardBtn').addEventListener('click', printSelectedIDCards); 
    document.getElementById('printBtn').addEventListener('click', printTable); 
    document.getElementById('pdfBtn').addEventListener('click', exportPDF);
    document.getElementById('excelBtn').addEventListener('click', exportCSV);
    document.getElementById('resetBtn').addEventListener('click', resetData);
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);
    
    // NEW LISTENERS
    logoUploadInput.addEventListener('change', handleLogoUpload); // NEW
    removeLogoBtn.addEventListener('click', removeLogo); // NEW

    document.getElementById('whatsappBtn').addEventListener('click', sendWhatsAppMessage); 
    document.getElementById('jsonBtn').addEventListener('click', exportJSON);
    
    document.getElementById('importJsonBtn').addEventListener('click', () => {
        importFileElement.click();
    });

    importFileElement.addEventListener('change', importDataFromJSON); 
    
    form.addEventListener('submit', saveOrUpdateRecord); 
    updateBtn.addEventListener('click', saveOrUpdateRecord); 
    
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);

    classFilter.addEventListener('change', loadAndDisplayData); 

    window.onload = () => {
        loadAndDisplayData();
        displayCurrentLogo(); // Load and display logo on startup
    };
</script>
</body>
</html>
